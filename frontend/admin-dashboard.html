<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/favicon4.png" />
  <title>CampusMate — Admin Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f6f8fb;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: #fff;
      border-right: 1px solid #eef2f6;
      min-height: 100vh;
    }

    .brand {
      padding: 18px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
    }

    .topbar {
      background: #fff;
      border-bottom: 1px solid #eef2f6;
      padding: 10px 20px;
    }

    .content {
      padding: 20px;
    }

    .card-ghost {
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(15, 23, 42, 0.06);
    }

    .muted {
      color: #64748b;
    }

    .table-fixed {
      max-height: 55vh;
      overflow: auto;
      display: block;
    }

    .search-input {
      max-width: 360px;
    }

    .small-muted {
      color: #94a3b8;
      font-size: 13px;
    }

    .center-title {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 18px;
    }

    .action-btns .btn {
      margin-left: 6px;
    }

    /* small attendance layout tweaks (only affect attendance area) */
    .adm-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .adm-actions .btn {
      min-width: 84px;
    }

    .adm-filters {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .adm-filters label {
      margin: 0 6px 0 0;
      color: #64748b;
      font-size: 13px;
    }

    /* Attendance layout tweaks (compact filters + centered action buttons) */
    #page-attendance .attendance-filters .form-select,
    #page-attendance .attendance-filters .form-control {
      padding: 4px 8px;
      font-size: 13px;
      height: 34px;
    }

    #page-attendance .attendance-filters .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #page-attendance .attendance-filters .filter-row label {
      margin-bottom: 0;
      margin-left: 2px;
      color: #6b7280;
      font-size: 13px;
    }

    /* updated: place actions immediately to the right of Load (in same row) */
    #page-attendance .attendance-filters .actions-inline {
      margin-left: 6px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* keep centered actions-row fallback styling (small vertical spacing) */
    #page-attendance .attendance-filters .actions-row {
      margin-top: 6px;
      margin-bottom: 12px;
      gap: 10px;
    }

    #page-attendance .attendance-card-body {
      margin-top: 10px;
    }

    /* make Export look balanced */
    #adminExportCsvBtn {
      min-width: 120px;
      padding-left: 10px;
      padding-right: 14px;
    }

    /* ========== Status badge styles ========== */
    /* ========== Status badge styles ========== */
    /* ensure the table reserves a fixed area for Batch/Year and Status columns,
      preventing other wide columns from pushing the status badge out of center */
    /* Make Email column narrower */
    #page-attendance table thead th:nth-child(1),
    #page-attendance table tbody td:nth-child(1) {
      width: 250px !important;
      /* adjust size here */
      max-width: 210px !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #page-attendance table thead th:nth-child(2),
    #page-attendance table tbody td:nth-child(2) {
      width: 250px !important;
      /* adjust size here */
      max-width: 200px !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #page-attendance table thead th:nth-child(3),
    #page-attendance table tbody td:nth-child(3) {
      width: 280px !important;
      /* adjust size here */
      max-width: 250px !important;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #page-attendance .table thead th:nth-child(4),
    #page-attendance .table thead th:nth-child(4) {
      width: 280px;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #page-attendance .table thead th:nth-child(5),
    #page-attendance .table tbody td:nth-child(5) {
      width: 250px;
      /* Batch / Year column */
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    #page-attendance .table thead th:nth-child(6),
    #page-attendance .table tbody td:nth-child(6) {
      /* width: 140px; Status column area */
      text-align: center;
      vertical-align: middle;
      padding-right: 18px;
      /* small spacing to avoid touching table edge */
    }

    /* explicit class for the status cell (if you use it) */
    .status-cell {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 12px 0;
      /* keeps vertical centering in each row */
    }

    /* the badge itself (smaller & centered) */
    .status-badge {
      display: inline-block;
      font-weight: 600;
      font-size: 12px;
      /* slightly smaller */
      padding: 6px 10px;
      /* compact */
      border-radius: 12px;
      /* softer pill */
      min-width: 86px;
      /* consistent width but smaller */
      text-align: center;
      margin: 0 auto;
      line-height: 1.1;
    }

    /* color variants */
    .status-present {
      background: #dcfce7;
      /* pale green background */
      color: #166534;
      border: 1px solid #16a34a;
    }

    .status-absent {
      background: #fee2e2;
      /* pale red */
      color: #7f1d1d;
      border: 1px solid #dc2626;
    }

    .status-notmarked {
      background: #f3f4f6;
      /* pale grey */
      color: #374151;
      border: 1px solid #e5e7eb;
    }

    /* responsive tweak */
    @media (max-width: 768px) {

      #page-attendance .table thead th:nth-child(5),
      #page-attendance .table tbody td:nth-child(5) {
        width: 130px;
      }

      #page-attendance .table thead th:nth-child(6),
      #page-attendance .table tbody td:nth-child(6) {
        width: 110px;
        padding-right: 8px;
      }

      .status-badge {
        min-width: 72px;
        padding: 5px 8px;
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .status-badge {
        min-width: 64px;
        padding: 4px 6px;
        font-size: 10px;
      }
    }

    /* ========== end badge styles ========== */

    /* System status strip (fixed to bottom of content area) */
    /* Adjust left to match your sidebar width (default 240px). If your layout already has a main-content offset, adjust left accordingly */
    .system-status-strip {
      position: fixed;
      right: 18px;
      bottom: 16px;
      background: rgba(18, 23, 31, 0.94);
      color: #fff;
      padding: 6px 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 0.85rem;
      z-index: 999;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      color: #aaa;
    }

    .status-dot.ok {
      color: #22c55e;
    }

    .status-dot.err {
      color: #ef4444;
    }

    .status-dot.checking {
      color: #9ca3af;
    }

    #status-sync-value {
      color: lightblue;
    }

    #status-response-value {
      color: lightgreen;
    }

    #status-response-value.response {
      color: #f87171;
    }
  </style>
</head>

<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <img src="assets/favicon5.png" class="logo-img" alt="CampusMate logo" />
        <div>
          <div>CampusMate</div>
          <div class="small-muted">Admin Panel</div>
        </div>
      </div>

      <div class="p-3">
        <div class="mb-3">
          <div id="adminName" class="fw-semibold">Admin</div>
          <div class="muted small-muted" id="adminEmail">
            admin@campusmate.com
          </div>
        </div>

        <hr />

        <div class="list-group">
          <a class="list-group-item list-group-item-action active" data-page="students" href="#">Students</a>
          <a class="list-group-item list-group-item-action" data-page="teachers" href="#">Teachers</a>
          <a class="list-group-item list-group-item-action" data-page="attendance" href="#">Attendance</a>
          <a class="list-group-item list-group-item-action" data-page="marks" href="#">Marks</a>
          <a class="list-group-item list-group-item-action" data-page="settings" href="#">Settings</a>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <div class="flex-fill">
      <div class="topbar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <h5 id="pageTitle" class="mb-0">Students</h5>
          <div id="pageSubtitle" class="small-muted">
            Manage students & records
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <!-- NEW: Batch filter (topbar) -->
          <select id="studentBatchFilter" class="form-select form-select-sm" style="min-width: 220px; cursor: pointer">
            <option value="">Select batch</option>
          </select>

          <!-- SEARCH -->
          <input id="studentSearchTop" class="form-control form-control-sm search-input"
            placeholder="Search by name / roll no" />
          <button id="addBtn" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
            <i class="bi bi-plus-lg"></i> Add
          </button>
          <button id="logout" class="btn btn-outline-secondary btn-sm">
            Logout
          </button>
        </div>
      </div>

      <div class="content">
        <!-- Students page -->
        <div id="page-students" class="page">
          <div class="card card-ghost p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="muted">Total Students</div>
                <div id="totalCount" class="h4 mb-0">0</div>
              </div>
              <div class="text-end small-muted">
                Last updated: <span id="lastUpdated">—</span>
              </div>
            </div>
          </div>

          <div class="card card-ghost p-3">
            <div class="table-responsive table-fixed" style="max-height: 52vh">
              <table class="table table-hover mb-0">
                <thead class="table-light sticky-top">
                  <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Course</th>
                    <th>Batch / Year</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="studentsBody"></tbody>
              </table>
            </div>
            <nav class="mt-3 d-flex justify-content-between align-items-center">
              <div class="small-muted">
                Showing <span id="showing">0</span> students
              </div>
              <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
            </nav>
          </div>
        </div>

        <!-- Teachers page -->
        <div id="page-teachers" class="page d-none">
          <div class="card card-ghost p-3 mb-3 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <h5 class="mb-0">Teachers</h5>
            </div>
            <div class="d-flex gap-2">
              <input id="searchTeachers" class="form-control" placeholder="Search teachers" />
              <button id="addTeacherBtn" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                data-bs-target="#addTeacherModal">
                <i class="bi bi-plus-lg"></i> Add Teacher
              </button>
            </div>
          </div>

          <div class="card card-ghost p-3">
            <div class="table-responsive" style="max-height: 60vh">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Course/Subject</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="teachersBody"></tbody>
              </table>
            </div>
            <div class="mt-2 small-muted">
              Total teachers: <span id="totalTeachers">0</span>
            </div>
          </div>
        </div>

        <!-- Admin Attendance Page (replaced for compact filters + centered buttons) -->
        <div id="page-attendance" class="page d-none">
          <div class="card card-ghost p-3">
            <h5>Attendance</h5>
            <p class="muted">
              Filter, load, edit and export attendance records.
            </p>

            <div class="attendance-filters">
              <!-- FILTER ROW -->
              <div class="filter-row">
                <div style="min-width: 180px">
                  <label class="small-muted mb-0">Course</label>
                  <select id="adminFilterCourse" class="form-select form-select-sm"
                    style="min-width: 180px; cursor: pointer">
                    <option value="">All courses</option>
                  </select>
                </div>

                <div style="min-width: 180px">
                  <label class="small-muted mb-0">Batch</label>
                  <select id="adminFilterBatch" class="form-select form-select-sm"
                    style="min-width: 180px; cursor: pointer">
                    <option value="">All batches</option>
                  </select>
                </div>

                <div style="min-width: 220px">
                  <label class="small-muted mb-0">Teacher</label>
                  <select id="adminFilterTeacher" class="form-select form-select-sm"
                    style="min-width: 220px; cursor: pointer">
                    <option value="">All teachers</option>
                  </select>
                </div>

                <div style="min-width: 160px">
                  <label class="small-muted mb-0">Date</label>
                  <input id="adminFilterDate" type="date" class="form-control form-control-sm"
                    style="width: 160px; cursor: pointer" />
                </div>

                <div style="margin-left: 6px; display: flex; align-items: center">
                  <label class="small-muted mb-0" style="visibility: hidden">&nbsp;</label>
                  <div>
                    <button style="margin-top: 20px" id="adminLoadAttendanceBtn" class="btn btn-outline-primary btn-sm">
                      Load
                    </button>
                  </div>
                </div>

                <!-- ACTIONS: Save removed per request; only Export remains -->
                <div class="actions-inline" style="margin-top: 20px; margin-left: 20px">
                  <button id="adminExportCsvBtn" class="btn btn-outline-secondary btn-sm">
                    Export CSV
                  </button>
                </div>
              </div>

              <!-- keep the old actions-row (in case some screens use it) - kept for spacing only -->
              <div class="actions-row d-none">
                <button id="adminExportCsvBtn_fallback" class="btn btn-outline-secondary btn-sm">
                  Export CSV
                </button>
              </div>
            </div>

            <!-- table area -->
            <div class="attendance-card-body">
              <div id="adminAttendanceMsg" class="text-danger small mb-2"></div>
              <div id="adminAttendanceArea">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th style="width: 120px">Roll No</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Course</th>
                        <th>Batch / Year</th>
                        <th style="width: 140px">Status</th>
                      </tr>
                    </thead>
                    <tbody id="adminAttendanceBody">
                      <tr>
                        <td colspan="6" class="text-muted p-3">
                          Select filters and click Load
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Marks page (ADMIN) - shows marks recorded by teachers -->
        <div id="page-marks" class="page d-none">
          <div class="card card-ghost p-3">
            <h5>Marks</h5>
            <p class="muted">View marks recorded by teachers.</p>

            <!-- Restored the previous inline filters layout (Batch | Teacher | Assessment | Date | Load | Export) -->
            <div class="d-flex align-items-center gap-3 mb-3" style="flex-wrap: wrap">
              <div style="min-width: 220px">
                <label class="small-muted mb-0">Batch</label>
                <select id="adminMarksBatch" class="form-select form-select-sm"
                  style="min-width: 220px; cursor: pointer">
                  <option value="">All batches</option>
                </select>
              </div>

              <div style="min-width: 220px">
                <label class="small-muted mb-0">Teacher</label>
                <select id="adminMarksTeacher" class="form-select form-select-sm"
                  style="min-width: 220px; cursor: pointer">
                  <option value="">All teachers</option>
                </select>
              </div>

              <div style="min-width: 220px">
                <label class="small-muted mb-0">Assessment</label>
                <input id="adminMarksAssessment" class="form-control form-control-sm" placeholder="optional"
                  style="min-width: 220px" />
              </div>

              <div style="min-width: 160px">
                <label class="small-muted mb-0">Date</label>
                <input id="adminMarksDate" type="date" class="form-control form-control-sm"
                  style="width: 160px; cursor: pointer" />
              </div>

              <div style="
                    display: flex;
                    align-items: flex-end;
                    gap: 8px;
                    margin-left: auto;
                  ">
                <button id="adminLoadMarksBtn" class="btn btn-outline-primary btn-sm">
                  Load
                </button>
                <button id="adminExportMarksCsvBtn" class="btn btn-outline-secondary btn-sm" style="margin-top: 28px">
                  Export CSV
                </button>
              </div>
            </div>

            <div id="adminMarksMsg" class="text-danger small mb-2"></div>

            <div id="adminMarksArea">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th style="width: 120px">Roll No</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Batch / Year</th>
                      <th>Teacher</th>
                      <th>Subject</th>
                      <th>Assessment</th>
                      <th>Marks</th>
                    </tr>
                  </thead>
                  <tbody id="adminMarksBody">
                    <tr>
                      <td colspan="8" class="text-muted p-3">
                        Select filters and click Load
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ================= Admin Settings ================= -->
        <div id="page-settings" class="page d-none">
          <div class="card card-ghost p-3">
            <h5>Settings</h5>
            <p class="muted">
              Admin profile, College/School info & Notifications
            </p>

            <div class="mt-3">
              <div class="btn-group mb-3" role="group" aria-label="settings tabs">
                <button id="tabProfile" class="btn btn-outline-primary btn-sm">
                  My Profile
                </button>
                <button id="tabSchool" class="btn btn-outline-primary btn-sm">
                  College/School Info
                </button>
                <button id="tabNotif" class="btn btn-outline-primary btn-sm">
                  Notifications
                </button>
              </div>

              <div id="settingsContent">
                <!-- Profile Pane -->
                <div id="paneProfile" class="settings-pane">
                  <form id="profileForm">
                    <div class="mb-2">
                      <label class="form-label">Name</label>
                      <input id="profile_name" class="form-control" name="name" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Email (readonly)</label>
                      <input id="profile_email" class="form-control" readonly />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Phone</label>
                      <input id="profile_phone" class="form-control" name="phone" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">New Password (leave blank to keep)</label>
                      <input id="profile_password" type="password" class="form-control" />
                    </div>
                    <div id="profileMsg" class="text-danger small mb-2"></div>
                    <div>
                      <button id="profileSaveBtn" class="btn btn-primary btn-sm">
                        Save Profile
                      </button>
                    </div>
                  </form>
                </div>

                <!-- School Pane -->
                <div id="paneSchool" class="settings-pane" style="display: none">
                  <form id="schoolForm">
                    <div class="mb-2">
                      <label class="form-label">School Name</label>
                      <input id="school_name" class="form-control" name="name" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Address</label>
                      <textarea id="school_address" class="form-control" name="address"></textarea>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Phone</label>
                      <input id="school_phone" class="form-control" name="phone" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Email</label>
                      <input id="school_email" class="form-control" name="email" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Website</label>
                      <input id="school_website" class="form-control" name="website" />
                    </div>
                    <div id="schoolMsg" class="text-danger small mb-2"></div>
                    <div>
                      <button id="schoolSaveBtn" class="btn btn-primary btn-sm">
                        Save School Info
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Notifications Pane -->
                <div id="paneNotif" class="settings-pane" style="display: none">
                  <div id="notifCreate" class="mb-3">
                    <h6>Create Notification</h6>
                    <form id="notifForm">
                      <div class="mb-2">
                        <label class="form-label">Title</label>
                        <input id="notif_title" class="form-control" name="title" />
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Message</label>
                        <textarea id="notif_message" class="form-control" name="message"></textarea>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Audience</label>
                        <select id="notif_audience" class="form-select">
                          <option value="teachers">Teachers</option>
                          <option value="students">Students</option>
                          <option value="both" selected>Both</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Type</label>
                        <select id="notif_type" class="form-select">
                          <option value="notice">Notice</option>
                          <option value="event">Event</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Send at (optional)</label>
                        <input id="notif_sendat" type="datetime-local" class="form-control" />
                      </div>
                      <div id="notifMsg" class="text-danger small mb-2"></div>
                      <div>
                        <button id="notifSendBtn" class="btn btn-primary btn-sm">
                          Send Notification
                        </button>
                      </div>
                    </form>
                  </div>

                  <hr />

                  <h6>All Notifications</h6>
                  <div id="notifList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- ================= end admin settings ================= -->
        <!-- System Status Strip (fixed to bottom of page content) -->
        <div id="systemStatusStrip" class="system-status-strip">
          <div class="status-left">
            <span id="status-server">Server </span>
            <span id="status-server-value" class="status-dot checking">Checking…</span>
          </div>
          <div class="status-mid">
            <span id="status-sync">Sync</span>
            <span id="status-sync-value">—</span>
          </div>
          <div class="status-right">
            <span id="status-response">Response</span>
            <span id="status-response-value">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Student Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 id="addModalTitle" class="modal-title">Add Student</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <input type="hidden" id="student_edit_id" value="" />
            <div class="mb-2">
              <input id="roll_no" class="form-control" placeholder="Roll No" required />
            </div>
            <div class="mb-2">
              <input id="name" class="form-control" placeholder="Full Name" required />
            </div>
            <div class="mb-2">
              <input id="email" class="form-control" placeholder="Email (optional)" />
            </div>

            <!-- Course select -->
            <div class="mb-2">
              <label class="form-label small-muted">Course</label>
              <select id="course" class="form-select" style="cursor: pointer" required>
                <option value="">Select course</option>
                <option value="BCA">BCA</option>
                <option value="BSc IT">BSc IT</option>
                <option value="BSc Computer Science">
                  BSc Computer Science
                </option>
                <option value="BCom">BCom</option>
                <option value="BA">BA</option>
                <option value="BBA">BBA</option>
                <option value="BMM">BMM</option>
                <option value="BTech">BTech</option>
                <option value="MCA">MCA</option>
                <option value="MSc">MSc</option>
              </select>
            </div>

            <!-- Batch select populated from /api/batches (value = batch_id) -->
            <div class="mb-2">
              <label class="form-label small-muted">Batch</label>
              <select id="batchSelect" class="form-select" style="cursor: pointer">
                <option value="">Select batch</option>
                <option value="FY">FY</option>
                <option value="SY">SY</option>
                <option value="TY">TY</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Year input -->
            <div class="mb-2">
              <label class="form-label small-muted">Year</label>
              <input id="year" type="number" class="form-control" placeholder="Year (e.g. 2025)" />
            </div>

            <div class="mb-2">
              <input id="password" class="form-control" placeholder="Password (default 123456)" />
            </div>
            <div id="addMsg" class="text-danger small mt-1"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button id="saveBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Teacher Modal -->
  <div class="modal fade" id="addTeacherModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 id="addTeacherTitle" class="modal-title">Add Teacher</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addTeacherForm">
            <input type="hidden" id="teacher_edit_id" value="" />
            <div class="mb-2">
              <input id="teacher_name" class="form-control" placeholder="Full Name" required />
            </div>
            <div class="mb-2">
              <input id="teacher_email" class="form-control" placeholder="Email" required />
            </div>
            <div class="mb-2">
              <input id="teacher_subject" class="form-control" placeholder="Course (e.g. Computer Science)" />
            </div>
            <div class="mb-2">
              <input id="teacher_specialization" class="form-control" placeholder="Subject" />
            </div>
            <div class="mb-2">
              <input id="teacher_password" class="form-control" placeholder="Password (default teacher123)" />
            </div>
            <div id="addTeacherMsg" class="text-danger small mt-1"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button id="saveTeacherBtn" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Batches Modal -->
  <div class="modal fade" id="assignBatchesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Assign Batches</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="assignBatchesContainer" class="mb-2"></div>
          <div id="assignBatchesMsg" class="text-danger small mt-1"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
          <button id="saveAssignBatchesBtn" class="btn btn-primary">
            Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = "http://localhost:5000/api";
    const token = localStorage.getItem("token");
    const admin = JSON.parse(localStorage.getItem("admin") || "null");

    if (!token) {
      window.location.href = "index.html";
    }
    if (admin) {
      document.getElementById("adminName").innerText = admin.name || "Admin";
      document.getElementById("adminEmail").innerText = admin.email || "";
    }

    function escapeHtml(text = "") {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    /* ---------- UX helpers: validation, toast, disable ---------- */

    // Show bootstrap toast with message
    function showToast(message) {
      const body = document.getElementById("appToastBody");
      const toastEl = document.getElementById("appToast");
      body.innerText = message;
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }

    // Enable / disable button and optionally show spinner inside
    function setButtonLoading(btnEl, isLoading) {
      if (!btnEl) return;
      if (isLoading) {
        btnEl.setAttribute("disabled", "disabled");
        // add spinner if none
        if (!btnEl.querySelector(".btn-spinner")) {
          const sp = document.createElement("span");
          sp.className = "spinner-border spinner-border-sm btn-spinner ms-2";
          sp.role = "status";
          sp.ariaHidden = "true";
          btnEl.appendChild(sp);
        }
      } else {
        btnEl.removeAttribute("disabled");
        const sp = btnEl.querySelector(".btn-spinner");
        if (sp) sp.remove();
      }
    }

    /* ---------- Form validators ---------- */

    // Student form validator: returns { ok: boolean, fields: { field: msg } }
    function validateStudentForm({ roll_no, name, course, year }) {
      const fields = {};
      if (!roll_no || !/^[A-Za-z0-9-]{2,30}$/.test(roll_no)) {
        fields.roll_no = "Roll number required (alpha-numeric, 2-30 chars)";
      }
      if (!name || name.length < 3)
        fields.name = "Full name required (min 3 chars)";
      if (!course) fields.course = "Select a course";
      if (year) {
        const y = Number(year);
        if (!Number.isInteger(y) || y < 2000 || y > 2100)
          fields.year = "Enter a valid year (e.g. 2025)";
      }
      return { ok: Object.keys(fields).length === 0, fields };
    }

    // Teacher form validator
    function validateTeacherForm({ name, email }) {
      const fields = {};
      if (!name || name.length < 3) fields.name = "Full name required";
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
        fields.email = "Valid email required";
      return { ok: Object.keys(fields).length === 0, fields };
    }

    // Display inline field errors (form = parent element, errorObj = { field: msg })
    function showInlineErrors(formEl, errorObj) {
      // clear previous
      formEl.querySelectorAll(".field-error").forEach((e) => e.remove());
      for (const [field, msg] of Object.entries(errorObj)) {
        const inp = formEl.querySelector(`#${field}`);
        if (inp) {
          const div = document.createElement("div");
          div.className = "field-error text-danger small mt-1";
          div.innerText = msg;
          inp.insertAdjacentElement("afterend", div);
        } else {
          // fallback toast
          showToast(msg);
        }
      }
    }

    /* -----------------------
 Batch options loader (fills batchSelect)
 ----------------------- */
    let allBatches = [];
    async function loadBatchOptions() {
      try {
        const res = await fetch(API + "/batches", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) return;
        allBatches = await res.json();

        const batchSelect = document.getElementById("batchSelect");

        // Remove previously appended dynamic options only (we mark them with data-dyn="1")
        Array.from(
          batchSelect.querySelectorAll('option[data-dyn="1"]')
        ).forEach((o) => o.remove());

        // Append fresh dynamic options (value = batch.id)
        allBatches.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = String(b.id); // numeric id as string
          opt.text = `${b.course || ""} — ${b.batch}${b.year ? " (" + b.year + ")" : ""
            }`;
          opt.setAttribute("data-dyn", "1"); // mark as dynamic
          batchSelect.appendChild(opt);
        });

        // --- ALSO populate the topbar student batch filter (studentBatchFilter) ---
        const studentBatchFilter =
          document.getElementById("studentBatchFilter");
        if (studentBatchFilter) {
          // reset to a single empty option
          studentBatchFilter.innerHTML =
            '<option value="">Select batch</option>';
          allBatches.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = String(b.id);
            opt.innerText = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
              }`;
            studentBatchFilter.appendChild(opt);
          });
          // keep blank selected by default
          if (!studentBatchFilter.value) studentBatchFilter.value = "";
        }
        // AUTO-SELECT first batch and load students
        if (studentBatchFilter && allBatches.length > 0) {
          studentBatchFilter.value = String(allBatches[0].id); // first batch
          loadStudents(); // load students automatically
        }
      } catch (err) {
        console.error("loadBatchOptions", err);
      }
    }

    /* -----------------------
 Students
 ----------------------- */
    const studentsBody = document.getElementById("studentsBody");
    const totalCount = document.getElementById("totalCount");
    const lastUpdated = document.getElementById("lastUpdated");
    const showing = document.getElementById("showing");
    const studentSearchTop = document.getElementById("studentSearchTop");
    const studentBatchFilter = document.getElementById("studentBatchFilter");
    let students = [];
    let filtered = [];
    let page = 1;
    const perPage = 8;

    async function loadStudents() {
      try {
        studentsBody.innerHTML = "";

        // read selected batch from topbar
        const batchSelTop = document.getElementById("studentBatchFilter");
        const selectedBatchId = batchSelTop ? batchSelTop.value : "";

        // If no batch selected -> show message as per your request
        if (!selectedBatchId) {
          students = [];
          filtered = [];
          totalCount.innerText = 0;
          lastUpdated.innerText = new Date().toLocaleString();
          page = 1;
          studentsBody.innerHTML =
            '<tr><td colspan="6" class="text-muted p-3">No students found. Select a batch to view students.</td></tr>';
          showing.innerText = 0;
          renderPagination();
          return;
        }

        // fetch students for the selected batch only
        const res = await fetch(
          API + "/students?batch_id=" + encodeURIComponent(selectedBatchId),
          {
            headers: { Authorization: "Bearer " + token },
          }
        );
        if (!res.ok) {
          studentsBody.innerHTML =
            '<tr><td colspan="6">Unable to load</td></tr>';
          return;
        }
        students = await res.json();

        // sort by roll_no (keep your original sort logic)
        students.sort((a, b) => {
          const ra = a && a.roll_no ? String(a.roll_no).trim() : "";
          const rb = b && b.roll_no ? String(b.roll_no).trim() : "";
          const na = Number(ra);
          const nb = Number(rb);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
          return ra.localeCompare(rb, undefined, {
            numeric: true,
            sensitivity: "base",
          });
        });

        filtered = students.slice();
        totalCount.innerText = students.length;
        lastUpdated.innerText = new Date().toLocaleString();
        page = 1;
        renderTable();
      } catch (err) {
        console.error(err);
        studentsBody.innerHTML =
          '<tr><td colspan="6" class="text-danger p-3">Server error</td></tr>';
      }
    }

    function renderTable() {
      const start = (page - 1) * perPage;
      const pageItems = filtered.slice(start, start + perPage);
      studentsBody.innerHTML = "";
      if (!pageItems.length) {
        studentsBody.innerHTML =
          '<tr><td colspan="6" class="text-muted p-3">No students found</td></tr>';
      } else {
        for (const s of pageItems) {
          // get batch display: prefer joined batch fields if present (std + batch_year)
          const batchText = s.std || "";
          const yearText = s.batch_year || s.year || "";
          const batchYear = batchText
            ? batchText + (yearText ? " / " + yearText : "")
            : yearText
              ? String(yearText)
              : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(s.roll_no)}</td>
                      <td>${escapeHtml(s.name)}</td>
                      <td>${escapeHtml(s.email || "")}</td>
                      <td>${escapeHtml(s.course || "")}</td>
                      <td>${escapeHtml(batchYear)}</td>
                      <td class="action-btns">
                        <button class="btn btn-sm btn-outline-secondary edit-student-btn" data-id="${s.id
            }"><i class="bi bi-pencil"></i> Edit</button>
                        <button class="btn btn-sm btn-danger delete-student-btn" data-id="${s.id
            }"><i class="bi bi-trash"></i> Delete</button>
                      </td>`;
          studentsBody.appendChild(tr);
        }
      }
      showing.innerText = Math.min(filtered.length, perPage * page);
      renderPagination();
    }

    function renderPagination() {
      const paginationEl = document.getElementById("pagination");
      paginationEl.innerHTML = "";
      const totalPages = Math.max(1, Math.ceil(filtered.length / perPage));
      function createPageItem(p, label = null, active = false) {
        const li = document.createElement("li");
        li.className = "page-item" + (active ? " active" : "");
        const a = document.createElement("a");
        a.className = "page-link";
        a.href = "#";
        a.innerText = label || p;
        a.addEventListener("click", (e) => {
          e.preventDefault();
          page = p;
          renderTable();
        });
        li.appendChild(a);
        return li;
      }
      const prev = document.createElement("li");
      prev.className = "page-item" + (page === 1 ? " disabled" : "");
      const pa = document.createElement("a");
      pa.className = "page-link";
      pa.href = "#";
      pa.innerHTML = "&laquo;";
      pa.addEventListener("click", (e) => {
        e.preventDefault();
        if (page > 1) {
          page--;
          renderTable();
        }
      });
      prev.appendChild(pa);
      paginationEl.appendChild(prev);
      const startPage = Math.max(1, page - 2);
      const endPage = Math.min(totalPages, page + 2);
      for (let p = startPage; p <= endPage; p++)
        paginationEl.appendChild(createPageItem(p, null, p === page));
      const next = document.createElement("li");
      next.className = "page-item" + (page === totalPages ? " disabled" : "");
      const na = document.createElement("a");
      na.className = "page-link";
      na.href = "#";
      na.innerHTML = "&raquo;";
      na.addEventListener("click", (e) => {
        e.preventDefault();
        if (page < totalPages) {
          page++;
          renderTable();
        }
      });
      next.appendChild(na);
      paginationEl.appendChild(next);
    }

    studentSearchTop.addEventListener("input", () => {
      const q = studentSearchTop.value.trim().toLowerCase();
      filtered = students.filter(
        (s) =>
          (s.name && s.name.toLowerCase().includes(q)) ||
          (s.roll_no && s.roll_no.toLowerCase().includes(q)) ||
          (s.email && s.email.toLowerCase().includes(q))
      );
      page = 1;
      renderTable();
    });

    /* -----------------------
 Teachers listing & assign batches
 ----------------------- */
    const teachersBody = document.getElementById("teachersBody");
    const totalTeachers = document.getElementById("totalTeachers");

    async function loadTeachers() {
      try {
        teachersBody.innerHTML = "";
        const res = await fetch(API + "/teachers", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) return;
        const list = await res.json();
        totalTeachers.innerText = list.length;

        for (const t of list) {
          // fetch assigned batches for teacher
          let assigned = [];
          try {
            const r = await fetch(API + `/teachers/${t.id}/batches`, {
              headers: { Authorization: "Bearer " + token },
            });
            if (r.ok) {
              const obj = await r.json();
              const batchIds = obj.batchIds || [];
              if (batchIds.length) {
                const allB = await fetch(API + "/batches", {
                  headers: { Authorization: "Bearer " + token },
                });
                if (allB.ok) {
                  const all = await allB.json();
                  assigned = all.filter((b) => batchIds.includes(b.id));
                }
              }
            }
          } catch (e) {
            console.error("fetch assigned batches", e);
          }

          const badgeHtml = assigned
            .map((b) => {
              return `<span class="badge bg-light text-dark me-1" style="font-weight:500;">
                  ${escapeHtml(b.course || "")} ${escapeHtml(b.batch || "")}${b.year ? " (" + escapeHtml(String(b.year)) + ")" : ""
                }
                  <button class="btn btn-sm btn-link p-0 ms-2 unassign-batch-btn" data-teacher="${t.id
                }" data-batch="${b.id
                }" title="Unassign" style="text-decoration:none;color:#d03a3a;">✕</button>
                </span>`;
            })
            .join(" ");

          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${escapeHtml(t.name)}</td>
        <td>${escapeHtml(t.email)}</td>
        <td>${escapeHtml(t.subject || "")}${t.specialization ? " / " + escapeHtml(t.specialization) : ""
            }<div class="mt-2">${badgeHtml}</div></td>
        <td>
          <button class="btn btn-sm btn-outline-secondary edit-teacher-btn" data-id="${t.id
            }"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-danger me-2 remove-teacher-btn" data-id="${t.id
            }">Remove</button>
          <button class="btn btn-sm btn-outline-primary assign-batches-btn" data-id="${t.id
            }">Assign Batches</button>
        </td>`;
          teachersBody.appendChild(tr);
        }
      } catch (err) {
        console.error("loadTeachers", err);
      }
    }

    /* -----------------------
 Delegated click handlers (edit/delete/assign)
 ----------------------- */
    document.addEventListener("click", async (e) => {
      // remove teacher
      if (e.target.matches(".remove-teacher-btn")) {
        const id = e.target.getAttribute("data-id");
        if (!confirm("Remove teacher?")) return;
        await fetch(API + "/teachers/" + id, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        });
        loadTeachers();
        return;
      }

      // assign batches open modal
      if (
        e.target.matches(".assign-batches-btn") ||
        e.target.closest(".assign-batches-btn")
      ) {
        const btn = e.target.matches(".assign-batches-btn")
          ? e.target
          : e.target.closest(".assign-batches-btn");
        const teacherId = btn.getAttribute("data-id");
        currentAssignTeacherId = teacherId;
        await openAssignBatchesModal(teacherId);
        return;
      }

      // unassign batch from teacher (delegated)
      if (
        e.target.matches(".unassign-batch-btn") ||
        e.target.closest(".unassign-batch-btn")
      ) {
        const btn = e.target.matches(".unassign-batch-btn")
          ? e.target
          : e.target.closest(".unassign-batch-btn");
        const teacherId = btn.getAttribute("data-teacher");
        const batchId = btn.getAttribute("data-batch");
        if (!confirm("Unassign this batch from the teacher?")) return;
        try {
          const r = await fetch(
            API + `/teachers/${teacherId}/batches/${batchId}`,
            {
              method: "DELETE",
              headers: { Authorization: "Bearer " + token },
            }
          );
          if (!r.ok) {
            alert("Failed to unassign");
            return;
          }
          await loadTeachers();
        } catch (err) {
          console.error("unassign", err);
          alert("Server error");
        }
        return;
      }

      // edit student
      if (
        e.target.matches(".edit-student-btn") ||
        e.target.closest(".edit-student-btn")
      ) {
        const btn = e.target.matches(".edit-student-btn")
          ? e.target
          : e.target.closest(".edit-student-btn");
        const id = btn.getAttribute("data-id");
        openEditStudent(id);
        return;
      }

      // delete student
      if (e.target.matches(".delete-student-btn")) {
        const id = e.target.getAttribute("data-id");
        if (!confirm("Delete student?")) return;
        try {
          const res = await fetch(API + "/students/" + id, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            alert("Failed to delete");
            return;
          }
          await loadStudents();
        } catch (err) {
          console.error(err);
          alert("Server error");
        }
        return;
      }

      // edit teacher
      if (
        e.target.matches(".edit-teacher-btn") ||
        e.target.closest(".edit-teacher-btn")
      ) {
        const btn = e.target.matches(".edit-teacher-btn")
          ? e.target
          : e.target.closest(".edit-teacher-btn");
        const id = btn.getAttribute("data-id");
        openEditTeacher(id);
        return;
      }
    });

    /* -----------------------
 Add Student: prefill/reset handlers
 ----------------------- */
    document.getElementById("addBtn").addEventListener("click", async () => {
      document.getElementById("addForm").reset();
      document.getElementById("student_edit_id").value = "";
      document.getElementById("addModalTitle").innerText = "Add Student";
      document.getElementById("addMsg").innerText = "";
      await loadBatchOptions(); // refresh batch list
    });

    /* Open edit student modal */
    async function openEditStudent(id) {
      try {
        const res = await fetch(API + "/students/" + id, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          alert("Failed to fetch student");
          return;
        }
        const s = await res.json();
        document.getElementById("student_edit_id").value = s.id;
        document.getElementById("roll_no").value = s.roll_no || "";
        document.getElementById("name").value = s.name || "";
        document.getElementById("email").value = s.email || "";
        document.getElementById("course").value = s.course || "";
        await loadBatchOptions();
        // If API returned joined batch, set batchSelect.value to s.batch_id (joined) or fallback
        document.getElementById("batchSelect").value = s.batch_id
          ? String(s.batch_id)
          : s.batch || "";
        document.getElementById("year").value = s.batch_year || s.year || "";
        document.getElementById("password").value = ""; // don't prefill password
        document.getElementById("addModalTitle").innerText = "Edit Student";
        new bootstrap.Modal(document.getElementById("addModal")).show();
      } catch (err) {
        console.error("openEditStudent", err);
        alert("Server error");
      }
    }

    /* Save (Add or Update) student */
    document.getElementById("saveBtn").addEventListener("click", async () => {
      const btn = document.getElementById("saveBtn");
      const editId = document.getElementById("student_edit_id").value || null;
      const roll_no = document.getElementById("roll_no").value.trim();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const course = document.getElementById("course").value.trim();
      const batchSelectValue = document.getElementById("batchSelect").value;
      const year = document.getElementById("year").value
        ? Number(document.getElementById("year").value)
        : null;
      const password = document.getElementById("password").value.trim();
      const msg = document.getElementById("addMsg");
      msg.innerText = "";
      // clear previous inline errors
      showInlineErrors(document.getElementById("addForm"), {});

      // client-side validation
      const v = validateStudentForm({ roll_no, name, course, year });
      if (!v.ok) {
        showInlineErrors(document.getElementById("addForm"), v.fields);
        return;
      }

      // build payload
      const payload = { roll_no, name, email, course, year };
      if (password) payload.password = password;
      if (batchSelectValue) {
        if (/^\d+$/.test(batchSelectValue))
          payload.batch_id = Number(batchSelectValue);
        else payload.batch = batchSelectValue;
      }

      try {
        setButtonLoading(btn, true);
        if (editId) {
          const res = await fetch(API + "/students/" + editId, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(payload),
          });
          const data = await res
            .json()
            .catch(() => ({ message: "Server error" }));
          if (!res.ok) {
            if (data.fields) {
              showInlineErrors(
                document.getElementById("addForm"),
                data.fields
              );
            } else msg.innerText = data.message || "Failed to update";
            return;
          }
          showToast("Student updated");
        } else {
          const res = await fetch(API + "/students", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(payload),
          });
          const data = await res
            .json()
            .catch(() => ({ message: "Server error" }));
          if (!res.ok) {
            if (data.fields) {
              showInlineErrors(
                document.getElementById("addForm"),
                data.fields
              );
            } else msg.innerText = data.message || "Failed to add student";
            return;
          }
          showToast("Student added");
        }

        const modalEl = document.querySelector("#addModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
        document.getElementById("addForm").reset();
        await loadStudents();
      } catch (err) {
        console.error(err);
        msg.innerText = "Server error";
      } finally {
        setButtonLoading(btn, false);
      }
    });

    /* -----------------------
 Add Teacher and Edit Teacher
 ----------------------- */
    document.getElementById("addTeacherBtn").addEventListener("click", () => {
      document.getElementById("addTeacherForm").reset();
      document.getElementById("teacher_edit_id").value = "";
      document.getElementById("addTeacherTitle").innerText = "Add Teacher";
      document.getElementById("addTeacherMsg").innerText = "";
    });

    async function openEditTeacher(id) {
      try {
        const res = await fetch(API + "/teachers/" + id, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          alert("Failed to fetch teacher");
          return;
        }
        const t = await res.json();
        document.getElementById("teacher_edit_id").value = t.id;
        document.getElementById("teacher_name").value = t.name || "";
        setTimeout(
          () => document.getElementById("teacher_name").focus(),
          200
        );
        document.getElementById("teacher_email").value = t.email || "";
        document.getElementById("teacher_subject").value = t.subject || "";
        document.getElementById("teacher_specialization").value =
          t.specialization || "";
        document.getElementById("teacher_password").value = "";
        document.getElementById("addTeacherTitle").innerText = "Edit Teacher";
        new bootstrap.Modal(
          document.getElementById("addTeacherModal")
        ).show();
      } catch (err) {
        console.error("openEditTeacher", err);
        alert("Server error");
      }
    }

    document
      .getElementById("saveTeacherBtn")
      .addEventListener("click", async () => {
        const btn = document.getElementById("saveTeacherBtn");
        const editId =
          document.getElementById("teacher_edit_id").value || null;
        const name = document.getElementById("teacher_name").value.trim();
        const email = document.getElementById("teacher_email").value.trim();
        const subject = document
          .getElementById("teacher_subject")
          .value.trim();
        const specialization = document
          .getElementById("teacher_specialization")
          .value.trim();
        const password = document
          .getElementById("teacher_password")
          .value.trim();
        const msg = document.getElementById("addTeacherMsg");
        msg.innerText = "";
        showInlineErrors(document.getElementById("addTeacherForm"), {});

        const v = validateTeacherForm({ name, email });
        if (!v.ok) {
          showInlineErrors(
            document.getElementById("addTeacherForm"),
            v.fields
          );
          return;
        }

        const payload = {
          name,
          email,
          subject: subject || null,
          specialization: specialization || null,
        };
        if (password) payload.password = password;

        try {
          setButtonLoading(btn, true);
          if (editId) {
            const res = await fetch(API + "/teachers/" + editId, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              const d = await res
                .json()
                .catch(() => ({ message: "Server error" }));
              if (d.fields) {
                showInlineErrors(
                  document.getElementById("addTeacherForm"),
                  d.fields
                );
              } else msg.innerText = d.message || "Failed to update";
              return;
            }
            showToast("Teacher updated");
          } else {
            const res = await fetch(API + "/teachers", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            const data = await res
              .json()
              .catch(() => ({ message: "Server error" }));
            if (!res.ok) {
              if (data.fields) {
                showInlineErrors(
                  document.getElementById("addTeacherForm"),
                  data.fields
                );
              } else msg.innerText = data.message || "Failed to add teacher";
              return;
            }
            showToast("Teacher added");
          }
          const modalEl = document.querySelector("#addTeacherModal");
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          document.getElementById("addTeacherForm").reset();
          await loadTeachers();
        } catch (err) {
          console.error("saveTeacher", err);
          msg.innerText = "Server error";
        } finally {
          setButtonLoading(btn, false);
        }
      });

    /* -----------------------
 Assign Batches modal logic
 ----------------------- */
    let currentAssignTeacherId = null;
    let currentAssignedBatchIds = [];

    async function openAssignBatchesModal(teacherId) {
      try {
        const [res1, res2] = await Promise.all([
          fetch(API + "/batches", {
            headers: { Authorization: "Bearer " + token },
          }),
          fetch(API + `/teachers/${teacherId}/batches`, {
            headers: { Authorization: "Bearer " + token },
          }),
        ]);
        const batches = await res1.json();
        const obj = await res2.json();
        const batchIds = obj.batchIds || [];
        currentAssignedBatchIds = batchIds.map(Number);

        const container = document.getElementById("assignBatchesContainer");
        container.innerHTML = "";
        batches.forEach((b) => {
          const checked = currentAssignedBatchIds.includes(b.id)
            ? "checked"
            : "";
          const div = document.createElement("div");
          div.className = "form-check";
          div.innerHTML = `<input class="form-check-input" type="checkbox" value="${b.id
            }" id="batch-${b.id}" ${checked}>
                       <label class="form-check-label" for="batch-${b.id}">${b.course
            } — ${b.batch}${b.year ? " (" + b.year + ")" : ""}</label>`;
          container.appendChild(div);
        });

        const modalEl = document.getElementById("assignBatchesModal");
        new bootstrap.Modal(modalEl).show();
      } catch (err) {
        console.error("openAssignBatchesModal", err);
      }
    }

    document
      .getElementById("saveAssignBatchesBtn")
      .addEventListener("click", async () => {
        try {
          const checkboxes = Array.from(
            document.querySelectorAll(
              '#assignBatchesContainer input[type="checkbox"]'
            )
          );
          const selected = checkboxes
            .filter((cb) => cb.checked)
            .map((cb) => Number(cb.value));
          // call bulk assign (backend will INSERT IGNORE duplicates)
          if (selected.length) {
            const res = await fetch(
              API + `/teachers/${currentAssignTeacherId}/batches`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + token,
                },
                body: JSON.stringify({ batchIds: selected }),
              }
            );
            if (!res.ok) {
              const d = await res.json().catch(() => ({ message: "Failed" }));
              document.getElementById("assignBatchesMsg").innerText =
                d.message || "Failed to assign";
              return;
            }
          } else {
            // If no selected, we can optionally unassign all (not doing it automatically here)
          }

          // To remove any batches that were unchecked, we need to compute previously assigned vs now.
          // We have currentAssignedBatchIds from when modal opened:
          const toUnassign = currentAssignedBatchIds.filter(
            (id) => !selected.includes(id)
          );
          for (const batchId of toUnassign) {
            await fetch(
              API + `/teachers/${currentAssignTeacherId}/batches/${batchId}`,
              {
                method: "DELETE",
                headers: { Authorization: "Bearer " + token },
              }
            );
          }

          // refresh UI
          const modalEl = document.getElementById("assignBatchesModal");
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          await loadTeachers(); // refresh teacher list (badges)
        } catch (err) {
          console.error("saveAssignBatches", err);
          document.getElementById("assignBatchesMsg").innerText =
            "Failed to save assignments";
        }
      });

    /* -----------------------
 Sidebar navigation (students / teachers toggles)
 ----------------------- */
    document
      .querySelectorAll(".list-group .list-group-item")
      .forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          document
            .querySelectorAll(".list-group .list-group-item")
            .forEach((a) => a.classList.remove("active"));
          item.classList.add("active");

          const page = item.getAttribute("data-page");
          document.getElementById("pageTitle").innerText =
            page.charAt(0).toUpperCase() + page.slice(1);
          document.getElementById("pageSubtitle").innerText =
            page === "teachers"
              ? "Manage teachers"
              : page === "students"
                ? "Manage students & records"
                : "";
          document
            .querySelectorAll(".page")
            .forEach((p) => p.classList.add("d-none"));
          document.getElementById("page-" + page).classList.remove("d-none");

          // show student-only controls on Students page
          if (page === "students") {
            studentSearchTop.style.display = "";
            if (studentBatchFilter) studentBatchFilter.style.display = "";
            loadStudents();
          } else {
            studentSearchTop.style.display = "none";
            if (studentBatchFilter) studentBatchFilter.style.display = "none";
          }

          // teachers page specific actions
          if (page === "teachers") loadTeachers();

          // if attendance clicked, initialize attendance filters
          if (page === "attendance" && window.initAdminAttendance) {
            // ensure the attendance module is initialized (populates filters)
            initAdminAttendance().catch(() => { });
          }

          // if marks clicked, initialize marks filters
          if (page === "marks" && window.initAdminMarks) {
            initAdminMarks().catch(() => { });
          }
        });
      });

    // initial load (Students page default)
    studentSearchTop.style.display = "";
    if (studentBatchFilter) studentBatchFilter.style.display = "";
    loadBatchOptions();
    loadStudents();
    loadTeachers();

    // When batch filter changes → reload students
    const studentBatchFilterEl =
      document.getElementById("studentBatchFilter");
    if (studentBatchFilterEl) {
      studentBatchFilterEl.addEventListener("change", () => {
        page = 1; // reset pagination
        loadStudents().catch((e) => console.error("loadStudents failed:", e));
      });
    }

    // teachers search (centered search on teachers page)
    document
      .getElementById("searchTeachers")
      .addEventListener("input", (e) => {
        const q = e.target.value.trim().toLowerCase();
        const rows = Array.from(
          document.querySelectorAll("#teachersBody tr")
        );
        rows.forEach((row) => {
          const txt = row.innerText.toLowerCase();
          row.style.display = txt.includes(q) ? "" : "none";
        });
      });
  </script>

  <!-- Admin attendance module (self-contained) - showing read-only colored badges and no Save -->
  <script>
    (function adminAttendanceCleanModule() {
      const API = "http://localhost:5000/api";
      const token = localStorage.getItem("token");

      // DOM refs
      const courseSel = document.getElementById("adminFilterCourse");
      const batchSel = document.getElementById("adminFilterBatch");
      const teacherSel = document.getElementById("adminFilterTeacher");
      const dateInp = document.getElementById("adminFilterDate");
      const loadBtn = document.getElementById("adminLoadAttendanceBtn");
      const exportBtn = document.getElementById("adminExportCsvBtn");
      const bodyEl = document.getElementById("adminAttendanceBody");
      const msgEl = document.getElementById("adminAttendanceMsg");

      if (
        !courseSel ||
        !batchSel ||
        !teacherSel ||
        !dateInp ||
        !loadBtn ||
        !exportBtn ||
        !bodyEl
      ) {
        console.warn(
          "Admin attendance elements missing; module not initialized."
        );
        return;
      }

      if (!dateInp.value)
        dateInp.value = new Date().toISOString().slice(0, 10);

      function escapeHtml(t = "") {
        return String(t)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function toast(msg) {
        if (window.showToast) showToast(msg);
        else alert(msg);
      }

      // load filters: batches and teachers
      async function loadFilters() {
        msgEl.innerText = "";
        try {
          const [bres, tres] = await Promise.all([
            fetch(API + "/batches", {
              headers: { Authorization: "Bearer " + token },
            }),
            fetch(API + "/teachers", {
              headers: { Authorization: "Bearer " + token },
            }),
          ]);
          const batches = bres.ok ? await bres.json() : [];
          const teachers = tres.ok ? await tres.json() : [];

          // populate batch select and derive courses set
          const courses = new Set();
          batchSel.innerHTML = '<option value="">All batches</option>';
          batches.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = String(b.id);
            opt.innerText = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
              }`;
            batchSel.appendChild(opt);
            if (b.course) courses.add(b.course);
          });

          // courses select
          courseSel.innerHTML = '<option value="">All courses</option>';
          Array.from(courses)
            .sort()
            .forEach((c) => {
              const o = document.createElement("option");
              o.value = c;
              o.innerText = c;
              courseSel.appendChild(o);
            });

          // teachers select
          teacherSel.innerHTML = '<option value="">All teachers</option>';
          teachers.forEach((t) => {
            const o = document.createElement("option");
            o.value = String(t.id);
            o.innerText = `${t.name} (${t.email || ""})`;
            teacherSel.appendChild(o);
          });
        } catch (err) {
          console.error("loadFilters", err);
          msgEl.innerText = "Failed to load filters";
        }
      }

      // LOAD attendance and render read-only badges (no selects)
      async function loadAttendance() {
        msgEl.innerText = "";
        bodyEl.innerHTML =
          '<tr><td colspan="6" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</td></tr>';
        const date = dateInp.value || new Date().toISOString().slice(0, 10);
        const batchId = batchSel.value;
        const teacherId = teacherSel.value;

        try {
          // Call attendance endpoint with optional filters
          let url = `${API}/attendance?date=${encodeURIComponent(date)}`;
          if (batchId) url += `&batch_id=${encodeURIComponent(batchId)}`;
          if (teacherId)
            url += `&teacher_id=${encodeURIComponent(teacherId)}`;
          const res = await fetch(url, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({ message: "Failed" }));
            msgEl.innerText = err.message || "Failed to load attendance";
            bodyEl.innerHTML =
              '<tr><td colspan="6" class="text-danger p-3">Unable to load data</td></tr>';
            return;
          }
          const rows = await res.json();

          // If batch filter provided, fetch students for that batch so we list every student
          let students = [];
          if (batchId) {
            const sres = await fetch(API + `/students?batch_id=${batchId}`, {
              headers: { Authorization: "Bearer " + token },
            });
            if (sres.ok) {
              students = await sres.json();
              // safeguard: only keep students whose batch_id matches selected batch
              students = students.filter((s) => {
                if (
                  typeof s.batch_id !== "undefined" &&
                  s.batch_id !== null
                ) {
                  return String(s.batch_id) === String(batchId);
                }
                return true; // fallback
              });
            } else {
              // fallback derive students from attendance rows and filter by batch if present in rows
              students = rows
                .filter((r) => {
                  if (
                    typeof r.batch_id !== "undefined" &&
                    r.batch_id !== null
                  ) {
                    return String(r.batch_id) === String(batchId);
                  }
                  return true;
                })
                .map((r) => ({
                  id: r.student_id,
                  roll_no: r.roll_no,
                  name: r.name,
                  email: r.email,
                  course: r.course,
                  std: r.std,
                  batch_year: r.batch_year,
                  batch_id: r.batch_id || null,
                }));
            }
          } else {
            // no batch => derive from attendance rows
            students = rows.map((r) => ({
              id: r.student_id,
              roll_no: r.roll_no,
              name: r.name,
              email: r.email,
              course: r.course,
              std: r.std,
              batch_year: r.batch_year,
              batch_id: r.batch_id || null,
            }));
          }

          // map attendance statuses by student id
          const attMap = {};
          rows.forEach((r) => {
            if (r.student_id) attMap[r.student_id] = r.status;
          });

          if (!students.length) {
            bodyEl.innerHTML =
              '<tr><td colspan="6" class="text-muted p-3">No students found for the selected filters</td></tr>';
            return;
          }

          bodyEl.innerHTML = "";
          // Sort students by roll_no ascending
          students.sort((a, b) => {
            const ra = a && a.roll_no ? String(a.roll_no).trim() : "";
            const rb = b && b.roll_no ? String(b.roll_no).trim() : "";
            const na = Number(ra);
            const nb = Number(rb);
            if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
            return ra.localeCompare(rb, undefined, {
              numeric: true,
              sensitivity: "base",
            });
          });

          for (const s of students) {
            // compute status and badge class BEFORE creating the row
            const status = attMap[s.id] || null; // e.g. "Present" / "Absent" or undefined
            let statusText = "Not marked";
            let badgeClass = "status-notmarked";

            if (status && String(status).toLowerCase() === "present") {
              statusText = "Present";
              badgeClass = "status-present";
            } else if (status && String(status).toLowerCase() === "absent") {
              statusText = "Absent";
              badgeClass = "status-absent";
            }

            // create row and cells
            const tr = document.createElement("tr");

            // Roll No
            const tdRoll = document.createElement("td");
            tdRoll.innerText = s.roll_no || "";
            tr.appendChild(tdRoll);

            // Name
            const tdName = document.createElement("td");
            tdName.innerText = s.name || "";
            tr.appendChild(tdName);

            // Email
            const tdEmail = document.createElement("td");
            tdEmail.innerText = s.email || "";
            tr.appendChild(tdEmail);

            // Course
            const tdCourse = document.createElement("td");
            tdCourse.innerText = s.course || "";
            tr.appendChild(tdCourse);

            // Batch / Year
            const tdBatch = document.createElement("td");
            tdBatch.innerText =
              (s.std || "") + (s.batch_year ? " / " + s.batch_year : "");
            tr.appendChild(tdBatch);

            // Status (centered badge)
            const tdStatus = document.createElement("td");
            tdStatus.className = "status-cell";
            const span = document.createElement("span");
            span.className = "status-badge " + badgeClass;
            span.innerText = statusText;
            tdStatus.appendChild(span);
            tr.appendChild(tdStatus);

            bodyEl.appendChild(tr);
          }
        } catch (err) {
          console.error("loadAttendance", err);
          msgEl.innerText = "Server error";
          bodyEl.innerHTML =
            '<tr><td colspan="6" class="text-danger p-3">Server error</td></tr>';
        }
      }

      // export CSV (unchanged; reads status text from cell)
      function exportCsv() {
        const rows = Array.from(
          document.querySelectorAll("#adminAttendanceBody tr")
        );
        if (!rows.length) {
          toast("No data to export");
          return;
        }
        const header = [
          "RollNo",
          "Name",
          "Email",
          "Course",
          "BatchYear",
          "Status",
        ];
        const csv = [header.join(",")];
        for (const r of rows) {
          const cells = Array.from(r.querySelectorAll("td"));
          if (cells.length < 6) continue;
          const roll = cells[0].innerText.replaceAll(",", " ");
          const name = cells[1].innerText.replaceAll(",", " ");
          const email = cells[2].innerText.replaceAll(",", " ");
          const course = cells[3].innerText.replaceAll(",", " ");
          const batch = cells[4].innerText.replaceAll(",", " ");
          const status = cells[5].innerText.replaceAll(",", " ");
          csv.push(
            [roll, name, email, course, batch, status]
              .map((v) => `"${String(v || "").replace(/"/g, '""')}"`)
              .join(",")
          );
        }
        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `attendance_${dateInp.value || new Date().toISOString().slice(0, 10)
          }.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // events
      loadBtn.addEventListener("click", loadAttendance);
      exportBtn.addEventListener("click", exportCsv);

      courseSel.addEventListener("change", () => {
        const c = courseSel.value;
        if (!c) {
          Array.from(batchSel.options).forEach((o) => (o.style.display = ""));
          batchSel.value = "";
          return;
        }
        Array.from(batchSel.options).forEach((o) => {
          if (!o.value) return;
          o.style.display = o.text.toLowerCase().includes(c.toLowerCase())
            ? ""
            : "none";
        });
        batchSel.value = "";
      });

      // expose init for sidebar to call
      window.initAdminAttendance = async function () {
        await loadFilters();
      };

      // quick init
      loadFilters().catch(() => { });
    })();
  </script>

  <!-- Admin marks module (self-contained) -->
  <script>
    (function adminMarksModule() {
      const API = "http://localhost:5000/api";
      const token = localStorage.getItem("token");

      const batchSel = document.getElementById("adminMarksBatch");
      const teacherSel = document.getElementById("adminMarksTeacher");
      const assessmentInp = document.getElementById("adminMarksAssessment");
      const dateInp = document.getElementById("adminMarksDate");
      const loadBtn = document.getElementById("adminLoadMarksBtn");
      const exportBtn = document.getElementById("adminExportMarksCsvBtn");
      const bodyEl = document.getElementById("adminMarksBody");
      const msgEl = document.getElementById("adminMarksMsg");

      if (
        !batchSel ||
        !teacherSel ||
        !assessmentInp ||
        !dateInp ||
        !loadBtn ||
        !exportBtn ||
        !bodyEl
      ) {
        console.warn("Admin marks elements missing; module not initialized.");
        return;
      }

      if (!dateInp.value)
        dateInp.value = new Date().toISOString().slice(0, 10);

      function toast(msg) {
        if (window.showToast) showToast(msg);
        else alert(msg);
      }

      // maintain teacher map for lookup when mark rows contain only teacher_id
      let teachersMap = {};

      // Load filters for marks page (batches + teachers)
      async function loadFilters() {
        msgEl.innerText = "";
        try {
          const [bres, tres] = await Promise.all([
            fetch(API + "/batches", {
              headers: { Authorization: "Bearer " + token },
            }),
            fetch(API + "/teachers", {
              headers: { Authorization: "Bearer " + token },
            }),
          ]);
          const batches = bres.ok ? await bres.json() : [];
          const teachers = tres.ok ? await tres.json() : [];

          batchSel.innerHTML = '<option value="">All batches</option>';
          batches.forEach((b) => {
            const opt = document.createElement("option");
            opt.value = String(b.id);
            opt.innerText = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
              }`;
            batchSel.appendChild(opt);
          });

          teacherSel.innerHTML = '<option value="">All teachers</option>';
          teachersMap = {}; // reset
          teachers.forEach((t) => {
            const opt = document.createElement("option");
            opt.value = String(t.id);
            opt.innerText = `${t.name} (${t.email || ""})`;
            teacherSel.appendChild(opt);
            // store both numeric and string keys to be robust
            teachersMap[String(t.id)] = t.name || t.email || "";
            teachersMap[Number(t.id)] = t.name || t.email || "";
          });
        } catch (err) {
          console.error("adminMarks.loadFilters", err);
          msgEl.innerText = "Failed to load filters";
        }
      }

      // Build URL with optional query params
      function buildMarksUrl({ date, batchId, teacherId, assessment }) {
        let url = `${API}/marks?date=${encodeURIComponent(date)}`;
        if (batchId) url += `&batch_id=${encodeURIComponent(batchId)}`;
        if (teacherId) url += `&teacher_id=${encodeURIComponent(teacherId)}`;
        if (assessment)
          url += `&assessment=${encodeURIComponent(assessment)}`;
        return url;
      }

      // Normalize a mark row into predictable fields for rendering.
      // Backend can return different shapes; attempt to extract student info.
      function normalizeRow(r) {
        // Expected fields: student_id, roll_no, name, email, std, batch_year, batch_id, teacher_name, subject, assessment, date, marks
        const student_id = r.student_id || r.sid || r.studentId || null;
        const roll_no = r.roll_no || r.roll || r.student_roll || "";
        const name = r.name || r.student_name || "";
        const email = r.email || r.student_email || "";
        const std = r.std || r.batch || r.student_batch || "";
        const batch_year =
          r.batch_year || r.year || r.student_batch_year || "";
        const batch_id = r.batch_id || r.batchId || null;
        const teacher =
          r.teacher_name ||
          r.teacher ||
          (r.teacher_info && r.teacher_info.name) ||
          r.recorded_by_name ||
          "" ||
          ""; // may be empty; we'll lookup by id later
        const teacher_id = r.teacher_id || r.tid || r.teacherId || null;
        const subject = r.subject || r.sub || "";
        const assessment = r.assessment || r.assess || "";
        const date = r.date || r.marked_at || r.recorded_on || "";
        const marks =
          typeof r.marks !== "undefined" && r.marks !== null
            ? r.marks
            : typeof r.mark === "number"
              ? r.mark
              : r.score || "";

        return {
          student_id,
          roll_no,
          name,
          email,
          std,
          batch_year,
          batch_id,
          teacher,
          teacher_id,
          subject,
          assessment,
          date,
          marks,
        };
      }

      // Load marks and render table
      async function loadMarks() {
        msgEl.innerText = "";
        bodyEl.innerHTML =
          '<tr><td colspan="8" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</td></tr>';

        const date = dateInp.value || new Date().toISOString().slice(0, 10);
        const batchId = batchSel.value;
        const teacherId = teacherSel.value;
        const assessment = (assessmentInp.value || "").trim();

        try {
          // === NEW: Check selected batch for students first (mirror attendance.js) ===
          // If a batch is selected and it has ZERO students, show "No Students found" and stop.
          let studentsMap = {};
          if (batchId) {
            try {
              const sres = await fetch(
                API + `/students?batch_id=${encodeURIComponent(batchId)}`,
                {
                  headers: { Authorization: "Bearer " + token },
                }
              );
              if (sres.ok) {
                const studs = await sres.json();
                // If the selected batch has zero students -> show message and return
                if (Array.isArray(studs) && studs.length === 0) {
                  bodyEl.innerHTML =
                    '<tr><td colspan="8" class="text-muted p-3">No Students found</td></tr>';
                  return;
                }
                // build studentsMap to be used later to enrich rows or fallback rendering
                if (Array.isArray(studs)) {
                  studs.forEach((s) => {
                    studentsMap[s.id] = s;
                  });
                }
              } else {
                // students endpoint failed — log and continue to attempt to load marks (fallback)
                console.warn(
                  "Failed to fetch students for batch check; proceeding to load marks."
                );
              }
            } catch (e) {
              console.warn(
                "Error fetching students for batch check; proceeding to load marks.",
                e
              );
            }
          }

          // === Fetch marks (only after confirming batch isn't empty or if no batch selected) ===
          const url = buildMarksUrl({ date, batchId, teacherId, assessment });
          const res = await fetch(url, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            const d = await res.json().catch(() => ({ message: "Failed" }));
            msgEl.innerText = d.message || "Failed to load marks";
            bodyEl.innerHTML =
              '<tr><td colspan="8" class="text-danger p-3">Unable to load data</td></tr>';
            return;
          }

          let rows = await res.json();
          if (!Array.isArray(rows)) {
            // backend may return { rows: [...] } or object; try to extract
            if (rows && Array.isArray(rows.rows)) rows = rows.rows;
            else rows = [];
          }

          // Normalize and present
          const norm = rows.map(normalizeRow);

          // If some student info missing, try to enrich from studentsMap
          for (const r of norm) {
            if (
              (!r.roll_no || !r.name) &&
              r.student_id &&
              studentsMap[r.student_id]
            ) {
              const s = studentsMap[r.student_id];
              r.roll_no = r.roll_no || s.roll_no || "";
              r.name = r.name || s.name || "";
              r.email = r.email || s.email || "";
              r.std = r.std || s.std || s.batch || "";
              r.batch_year = r.batch_year || s.batch_year || s.year || "";
            }

            // teacher name enrichment: if teacher missing but teacher_id present, look up from teachersMap
            // check several possible teacher-id fields
            const tidCandidate =
              r.teacher_id || r.tid || r.teacherId || r.teacher;
            if (
              (!r.teacher || r.teacher === "") &&
              typeof tidCandidate !== "undefined" &&
              tidCandidate !== null
            ) {
              if (teachersMap[String(tidCandidate)])
                r.teacher = teachersMap[String(tidCandidate)];
              else if (teachersMap[Number(tidCandidate)])
                r.teacher = teachersMap[Number(tidCandidate)];
            }
          }

          // If no marks rows AND the batchId was selected:
          // - only fallback to rendering students (with empty marks) if studentsMap actually contains students.
          if (!norm || !norm.length) {
            if (batchId) {
              if (Object.keys(studentsMap).length === 0) {
                // This case is unlikely now because we returned earlier when students were zero,
                // but keep a safe fallback message.
                bodyEl.innerHTML =
                  '<tr><td colspan="8" class="text-muted p-3">No marks found for the selected filters</td></tr>';
                return;
              } else {
                // students exist in batch but no marks rows: show students with empty marks (optional fallback)
                const fallback = Object.values(studentsMap).map((s) => ({
                  student_id: s.id,
                  roll_no: s.roll_no || "",
                  name: s.name || "",
                  email: s.email || "",
                  std: s.std || s.batch || "",
                  batch_year: s.batch_year || s.year || "",
                  teacher: "",
                  subject: "",
                  assessment: assessment || "",
                  date: date,
                  marks: "",
                }));
                renderRows(fallback);
                return;
              }
            } else {
              // no batch selected and no rows
              bodyEl.innerHTML =
                '<tr><td colspan="8" class="text-muted p-3">No marks found for the selected filters</td></tr>';
              return;
            }
          }

          renderRows(norm);
        } catch (err) {
          console.error("adminMarks.loadMarks", err);
          msgEl.innerText = "Server error";
          bodyEl.innerHTML =
            '<tr><td colspan="8" class="text-danger p-3">Server error</td></tr>';
        }
      }
      function renderRows(rows) {
        if (!rows || rows.length === 0) {
          bodyEl.innerHTML =
            '<tr><td colspan="8" class="text-muted p-3">No marks found for the selected filters</td></tr>';
          return;
        }

        // sort by roll_no if present
        rows.sort((a, b) => {
          const ra = a && a.roll_no ? String(a.roll_no).trim() : "";
          const rb = b && b.roll_no ? String(b.roll_no).trim() : "";
          const na = Number(ra);
          const nb = Number(rb);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
          return ra.localeCompare(rb, undefined, {
            numeric: true,
            sensitivity: "base",
          });
        });

        bodyEl.innerHTML = "";
        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(r.roll_no || "")}</td>
                            <td>${escapeHtml(r.name || "")}</td>
                            <td>${escapeHtml(r.email || "")}</td>
                            <td>${escapeHtml(
            (r.std || "") +
            (r.batch_year ? " / " + r.batch_year : "")
          )}</td>
                            <td>${escapeHtml(r.teacher || "")}</td>
                            <td>${escapeHtml(r.subject || "")}</td>
                            <td>${escapeHtml(r.assessment || "")}</td>
                            <td>${escapeHtml(String(r.marks || ""))}</td>`;
          bodyEl.appendChild(tr);
        }
      }

      // Export CSV
      function exportCsv() {
        const rows = Array.from(
          document.querySelectorAll("#adminMarksBody tr")
        );
        if (!rows.length) {
          toast("No data to export");
          return;
        }

        const header = [
          "RollNo",
          "Name",
          "Email",
          "BatchYear",
          "Teacher",
          "Subject",
          "Assessment",
          "Marks",
        ];
        const csv = [header.join(",")];

        for (const r of rows) {
          const cells = Array.from(r.querySelectorAll("td"));
          if (cells.length < 8) continue;
          const rowVals = cells
            .slice(0, 8)
            .map((c) => c.innerText.replaceAll(",", " "));
          csv.push(
            rowVals
              .map((v) => `"${String(v || "").replace(/"/g, '""')}"`)
              .join(",")
          );
        }

        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `marks_${dateInp.value || new Date().toISOString().slice(0, 10)
          }.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // wire events
      loadBtn.addEventListener("click", loadMarks);
      exportBtn.addEventListener("click", exportCsv);

      // expose init function for sidebar to call
      window.initAdminMarks = async function () {
        await loadFilters();
      };

      // quick init
      loadFilters().catch(() => { });
    })();
  </script>

  <script>
    (function () {
      const API = "http://localhost:5000/api";
      const API_BASE = API;
      const token = localStorage.getItem("token");

      // simple escape helper
      function escapeHtml(s = "") {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function showToastSafe(msg) {
        if (typeof showToast === "function") showToast(msg);
        else console.log(msg);
      }

      // tabs
      const tabProfile = document.getElementById("tabProfile");
      const tabSchool = document.getElementById("tabSchool");
      const tabNotif = document.getElementById("tabNotif");
      const paneProfile = document.getElementById("paneProfile");
      const paneSchool = document.getElementById("paneSchool");
      const paneNotif = document.getElementById("paneNotif");

      function showPane(p) {
        paneProfile.style.display = "none";
        paneSchool.style.display = "none";
        paneNotif.style.display = "none";
        p.style.display = "";
      }

      function setActiveTab(activeBtn) {
        [tabProfile, tabSchool, tabNotif].forEach((btn) => {
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline-primary");
        });

        activeBtn.classList.remove("btn-outline-primary");
        activeBtn.classList.add("btn-primary");
      }

      tabProfile.addEventListener("click", () => {
        showPane(paneProfile);
        setActiveTab(tabProfile);
      });

      tabSchool.addEventListener("click", () => {
        showPane(paneSchool);
        setActiveTab(tabSchool);
      });

      tabNotif.addEventListener("click", () => {
        showPane(paneNotif);
        setActiveTab(tabNotif);
      });

      // PROFILE: load & save
      async function loadProfile() {
        try {
          const res = await fetch(API_BASE + "/settings/profile", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) return;
          const p = await res.json();
          if (!p) return;
          document.getElementById("profile_name").value = p.name || "";
          document.getElementById("profile_email").value = p.email || "";
          document.getElementById("profile_phone").value = p.phone || "";
        } catch (e) {
          console.error("loadProfile", e);
        }
      }

      document
        .getElementById("profileSaveBtn")
        .addEventListener("click", async (ev) => {
          ev.preventDefault();
          const msgEl = document.getElementById("profileMsg");
          msgEl.innerText = "";

          // Build payload only with non-empty values
          const payload = {};
          const nameVal = document
            .getElementById("profile_name")
            .value.trim();
          if (nameVal !== "") payload.name = nameVal;

          const phoneVal = document
            .getElementById("profile_phone")
            .value.trim();
          if (phoneVal !== "") payload.phone = phoneVal; // send phone only when non-empty

          // password for admin: send only if provided (non-empty)
          const pw = document.getElementById("profile_password").value;
          if (pw && String(pw).trim() !== "") payload.password = pw;

          if (Object.keys(payload).length === 0) {
            msgEl.innerText = "No changes to save";
            return;
          }

          try {
            const res = await fetch(API_BASE + "/settings/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            const j = await res
              .json()
              .catch(() => ({ message: "Server error" }));
            if (!res.ok) {
              msgEl.innerText = j.message || "Save failed";
              return;
            }

            // refresh profile from server (ensures phone shows correctly)
            await loadProfile();

            // update localStorage user/admin if present
            try {
              const k = localStorage.getItem("user")
                ? "user"
                : localStorage.getItem("admin")
                  ? "admin"
                  : null;
              if (k) {
                const u = JSON.parse(localStorage.getItem(k));
                if (payload.name) u.name = payload.name;
                if (payload.phone) u.phone = payload.phone;
                localStorage.setItem(k, JSON.stringify(u));
                // update sidebar display if present
                const nameEl = document.getElementById("adminName");
                const emailEl = document.getElementById("adminEmail");
                if (nameEl) nameEl.innerText = u.name || nameEl.innerText;
                if (emailEl) emailEl.innerText = u.email || emailEl.innerText;
              }
            } catch (e) {
              // ignore localStorage update errors
            }

            msgEl.innerText = "";
            showToastSafe("Profile updated");
          } catch (err) {
            console.error("save profile", err);
            msgEl.innerText = "Server error";
          }
        });

      // SCHOOL: load & save
      async function loadSchool() {
        try {
          const res = await fetch(API_BASE + "/settings/school", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) return;
          const s = await res.json();
          if (!s) return;
          document.getElementById("school_name").value = s.name || "";
          document.getElementById("school_address").value = s.address || "";
          document.getElementById("school_phone").value = s.phone || "";
          document.getElementById("school_email").value = s.email || "";
          document.getElementById("school_website").value = s.website || "";
        } catch (e) {
          console.error("loadSchool", e);
        }
      }
      document
        .getElementById("schoolSaveBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const msgEl = document.getElementById("schoolMsg");
          msgEl.innerText = "";
          const payload = {
            name: document.getElementById("school_name").value.trim() || null,
            address:
              document.getElementById("school_address").value.trim() || null,
            phone:
              document.getElementById("school_phone").value.trim() || null,
            email:
              document.getElementById("school_email").value.trim() || null,
            website:
              document.getElementById("school_website").value.trim() || null,
          };
          try {
            const res = await fetch(API_BASE + "/settings/school", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            const j = await res
              .json()
              .catch(() => ({ message: "Server error" }));
            if (!res.ok) {
              msgEl.innerText = j.message || "Save failed";
              return;
            }
            msgEl.innerText = "";
            showToastSafe("School info updated");
          } catch (err) {
            console.error("save school", err);
            msgEl.innerText = "Server error";
          }
        });

      // NOTIFICATIONS: create & list
      async function loadNotifications() {
        try {
          const res = await fetch(API_BASE + "/settings/notifications", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            document.getElementById("notifList").innerHTML =
              '<div class="small-muted">Failed to load</div>';
            return;
          }
          const list = await res.json();
          const container = document.getElementById("notifList");
          container.innerHTML = "";
          if (!Array.isArray(list) || !list.length) {
            container.innerHTML =
              '<div class="small-muted">No notifications</div>';
            return;
          }

          list.forEach((n) => {
            // main notification container
            const el = document.createElement("div");
            el.className =
              "p-2 border rounded mb-2 d-flex justify-content-between align-items-start";

            // left: content
            const left = document.createElement("div");
            left.style.flex = "1";
            left.innerHTML = `<div class="fw-semibold">${escapeHtml(
              n.title
            )} &nbsp; <small class="text-muted">(${escapeHtml(
              n.type
            )})</small></div>
          <div>${escapeHtml(n.message)}</div>
          <div class="small-muted">${n.created_at ? new Date(n.created_at).toLocaleString() : ""
              }</div>`;

            // right: actions (delete)
            const actions = document.createElement("div");
            actions.style.marginLeft = "12px";
            actions.style.display = "flex";
            actions.style.flexDirection = "column";
            actions.style.gap = "6px";

            // Delete button (admin page — safe to always show here)
            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-sm btn-outline-danger";
            delBtn.innerText = "Delete";
            delBtn.addEventListener("click", async () => {
              if (!confirm("Delete this notification for all users?")) return;
              try {
                delBtn.disabled = true;
                const resp = await fetch(
                  API_BASE +
                  "/settings/notifications/" +
                  encodeURIComponent(n.id),
                  {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token },
                  }
                );
                if (!resp.ok) {
                  const json = await resp.json().catch(() => ({}));
                  alert(json.message || "Delete failed");
                  delBtn.disabled = false;
                  return;
                }
                // remove from DOM and show toast
                el.remove();
                if (typeof showToast === "function")
                  showToast("Notification deleted");
              } catch (err) {
                console.error("delete notif", err);
                alert("Server error");
                delBtn.disabled = false;
              }
            });

            actions.appendChild(delBtn);

            el.appendChild(left);
            el.appendChild(actions);
            container.appendChild(el);
          });
        } catch (e) {
          console.error("loadNotifications", e);
          document.getElementById("notifList").innerHTML =
            '<div class="small-muted">No notifications</div>';
        }
      }

      document
        .getElementById("notifSendBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const msgEl = document.getElementById("notifMsg");
          msgEl.innerText = "";
          const payload = {
            title: document.getElementById("notif_title").value.trim(),
            message: document.getElementById("notif_message").value.trim(),
            audience: document.getElementById("notif_audience").value,
            type: document.getElementById("notif_type").value,
            send_at: document.getElementById("notif_sendat").value || null,
          };
          if (!payload.title || !payload.message) {
            msgEl.innerText = "Title and message required";
            return;
          }
          try {
            const res = await fetch(API_BASE + "/settings/notifications", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            const j = await res
              .json()
              .catch(() => ({ message: "Server error" }));
            if (!res.ok) {
              msgEl.innerText = j.message || "Failed";
              return;
            }
            document.getElementById("notifForm").reset();
            loadNotifications();
            showToastSafe("Notification created");
          } catch (err) {
            console.error("create notif", err);
            msgEl.innerText = "Server error";
          }
        });

      // initialize when admin settings tab is shown by sidebar logic
      document.addEventListener("DOMContentLoaded", () => {
        const pageSettings = document.getElementById("page-settings");
        const observer = new MutationObserver((mut) => {
          if (pageSettings && !pageSettings.classList.contains("d-none")) {
            loadProfile().catch(() => { });
            loadSchool().catch(() => { });
            loadNotifications().catch(() => { });
            showPane(paneProfile);
            setActiveTab(tabProfile);
            observer.disconnect();
          }
        });
        if (pageSettings)
          observer.observe(pageSettings, {
            attributes: true,
            attributeFilter: ["class"],
          });
      });
    })();
  </script>

  <script>
    function updateSystemStatus({
      server = "Checking…",
      serverState = "checking",
      sync = "—",
      response = "—",
    } = {}) {
      const serverEl = document.getElementById("status-server-value");
      const syncEl = document.getElementById("status-sync-value");
      const respEl = document.getElementById("status-response-value");

      if (serverEl) {
        serverEl.innerText = server;
        serverEl.className = "status-dot " + serverState;
      }
      if (syncEl) syncEl.innerText = sync;
      if (respEl) respEl.innerText = response;
    }

    async function pollSystemStatus() {
      const start = performance.now();

      try {
        const res = await fetch(`${API}/health`, {
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
        });

        const ms = Math.round(performance.now() - start);

        if (!res.ok) {
          updateSystemStatus({
            server: "Down",
            serverState: "err",
            sync: "—",
            response: ms + "ms",
          });
          return;
        }

        const data = await res.json();

        updateSystemStatus({
          server: data.status || "OK",
          serverState: data.status === "OK" ? "ok" : "err",
          sync: data.sync || "Online",
          response: ms + "ms",
        });
      } catch (e) {
        updateSystemStatus({
          server: "Error",
          serverState: "err",
          sync: "—",
          response: "N/A",
        });
      }
    }

    // initial + interval
    setTimeout(() => {
      pollSystemStatus();
      setInterval(pollSystemStatus, 30000);
    }, 500);
  </script>

  <!-- Toast container (place near end of body) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div id="appToastBody" class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal (paste once near end of <body>) -->
  <style>
    /* small local styles for the modal icon & layout */
    .logout-modal .icon-wrap {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      background: rgba(220, 53, 69, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px auto;
    }

    .logout-modal .icon-wrap svg {
      width: 36px;
      height: 36px;
      color: #dc3545;
    }

    .logout-modal .modal-title {
      text-align: center;
      font-weight: 600;
    }

    .logout-modal .modal-body {
      text-align: center;
      color: #6b7280;
    }

    .logout-modal .modal-footer {
      justify-content: center;
      gap: 12px;
      padding-bottom: 18px;
    }
  </style>

  <div class="modal fade logout-modal" id="logoutConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-body pt-4 pb-0 px-4">
          <div class="icon-wrap mb-2" aria-hidden="true">
            <!-- error / warning SVG -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M11.001 7h2v6h-2V7zM11 15h2v2h-2v-2z" fill="currentColor" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M1.257 20.71A1 1 0 0 0 2.18 22h19.64a1 1 0 0 0 .923-1.29L13.923 3.29a1 1 0 0 0-1.846 0L1.257 20.71zM4.06 20L12 5.157 19.94 20H4.06z"
                fill="currentColor" />
            </svg>
          </div>

          <h5 class="modal-title">Are you sure?</h5>
          <p class="modal-body small">
            You will be logged out and your session will end on this device.
          </p>
        </div>

        <div class="modal-footer pb-3">
          <button id="confirmLogoutBtn" type="button" class="btn btn-danger">
            Logout
          </button>
          <button id="cancelLogoutBtn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const logoutBtn = document.getElementById("logout"); // top-right logout button
      const confirmBtn = document.getElementById("confirmLogoutBtn"); // modal confirm
      const logoutModalEl = document.getElementById("logoutConfirmModal");

      if (!logoutBtn) {
        console.warn("Logout button not found (#logout)");
      } else {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (!logoutModalEl) {
            console.warn("Logout modal not found (#logoutConfirmModal)");
            return;
          }
          try {
            const modal = new bootstrap.Modal(logoutModalEl);
            modal.show();
          } catch (err) {
            console.error("Failed to show logout modal", err);
          }
        });
      }

      if (!confirmBtn) {
        console.warn("Confirm logout button not found (#confirmLogoutBtn)");
        return;
      }

      confirmBtn.addEventListener("click", async () => {
        try {
          // disable confirm button & add spinner
          confirmBtn.setAttribute("disabled", "disabled");
          const spinner = document.createElement("span");
          spinner.className = "spinner-border spinner-border-sm ms-2";
          spinner.setAttribute("role", "status");
          spinner.ariaHidden = "true";
          spinner.dataset.temp = "spinner";
          confirmBtn.appendChild(spinner);

          // clear session
          try {
            localStorage.removeItem("user");
            localStorage.removeItem("role");
            localStorage.removeItem("token");
          } catch (e) {
            console.warn("Failed clearing localStorage", e);
          }

          // hide modal
          const modalInstance = bootstrap.Modal.getInstance(logoutModalEl);
          if (modalInstance) modalInstance.hide();

          setTimeout(() => {
            window.location.href = "index.html";
          }, 180);
        } catch (err) {
          console.error("Error during logout", err);
          confirmBtn.removeAttribute("disabled");
          const s = confirmBtn.querySelector('[data-temp="spinner"]');
          if (s) s.remove();
        }
      });
    });
  </script>
</body>

</html>