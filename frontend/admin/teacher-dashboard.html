<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/logowhite.png" />
  <title>CampusMate — Teacher Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #f6f8fb;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: #fff;
      border-right: 1px solid #eef2f6;
      min-height: 100vh;
    }

    .brand {
      padding: 18px;
      font-weight: 600;
      color: #0f172a;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
    }

    .topbar {
      background: #fff;
      border-bottom: 1px solid #eef2f6;
      padding: 10px 20px;
    }

    .content {
      padding: 20px;
    }

    .card-ghost {
      border-radius: 12px;
      box-shadow: 0 6px 22px rgba(15, 23, 42, 0.06);
    }

    .muted {
      color: #64748b;
    }

    .small-muted {
      color: #94a3b8;
      font-size: 13px;
    }

    .tile-card {
      padding: 20px;
      border-radius: 14px;
      background: white;
      box-shadow: 0 6px 22px rgba(15, 23, 42, 0.06);
      transition: 0.2s ease;
    }

    .tile-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 26px rgba(0, 0, 0, 0.08);
    }

    /* Added: present/absent buttons for attendance rows */
    .att-btn {
      min-width: 46px;
      height: 34px;
      border-radius: 6px;
      padding: 2px 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid #d1d5db;
      background: #fff;
      color: #111827;
      user-select: none;
    }

    .att-btn .icon {
      margin-left: 6px;
      font-size: 14px;
      line-height: 1;
    }

    .att-btn.present.active {
      background: #dcfce7;
      /* pale green */
      border-color: #16a34a;
      color: #166534;
    }

    .att-btn.absent.active {
      background: #fee2e2;
      /* pale red */
      border-color: #dc2626;
      color: #7f1d1d;
    }

    .att-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
    }

    /* Marks UI small tweaks */
    .marks-filters .form-control,
    .marks-filters .form-select {
      height: 36px;
      padding: 6px 8px;
      font-size: 13px;
    }

    #marksArea .table td input[type="number"] {
      width: 100px;
    }

    /* Subject input width */
    #marksArea .table td input.subject-input {
      width: 160px;
    }

    .marks-note {
      font-size: 13px;
      color: #64748b;
    }

    .marks-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* small, safe chart height so line becomes readable */
    .attendance-chart-wrap {
      height: 140px;
      position: relative;
    }

    .attendance-chart-wrap canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    /* XP tile styling */
    /* Make XP tile shorter & wider */
    .xp-tile-card {
      min-height: 90px !important;
      padding: 16px 22px !important;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      margin-top: 20px;
      gap: 10px;
      box-shadow: 0 6px 22px rgba(15, 23, 42, 0.06);
    }

    .xp-title {
      font-size: 1rem;
      font-weight: 600;
      color: #475569;
    }

    .xp-points {
      font-size: 2rem !important;
      line-height: 1.1;
    }

    .xp-level-meta {
      font-size: 0.95rem;
      font-weight: 600;
      color: #64748b;
    }

    /* XP bar sizing */
    .xp-progress {
      height: 12px;
      border-radius: 10px;
      background: #e7ecf5;
    }

    .xp-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #2ad0c9, #2b9dff);
      border-radius: 10px;
      transition: width 0.4s ease;
    }

    .xp-progress-text {
      margin-top: 6px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* XP card becomes VERY wide on larger screens */
    @media (min-width: 992px) {
      #teacherXPCard {
        width: 100%;
      }
    }

    /* System status strip (fixed to bottom of content area) */
    /* Adjust left to match your sidebar width (default 240px). If your layout already has a main-content offset, adjust left accordingly */
    .system-status-strip {
      position: fixed;
      right: 18px;
      bottom: 16px;
      background: rgba(18, 23, 31, 0.94);
      color: #fff;
      padding: 6px 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 0.85rem;
      z-index: 999;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      color: #aaa;
    }

    .status-dot.ok {
      color: #22c55e;
    }

    .status-dot.err {
      color: #ef4444;
    }

    .status-dot.checking {
      color: #9ca3af;
    }

    #status-sync-value {
      color: lightblue;
    }

    #status-response-value {
      color: lightgreen;
    }

    /* Settings tab active state */
    .settings-tab.active {
      background-color: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
    }
  </style>
</head>

<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <img src="assets/logoblue.png" class="logo-img" alt="logo" />
        <div>
          <div>CampusMate</div>
          <div class="small-muted">Teacher Panel</div>
        </div>
      </div>

      <div class="p-3">
        <div class="mb-3">
          <div id="teacherName" class="fw-semibold">Teacher</div>
          <div class="muted small-muted" id="teacherEmail">
            teacher@campusmate.com
          </div>
        </div>

        <hr />

        <div class="list-group">
          <a class="list-group-item list-group-item-action active" data-page="dashboard" href="#">Dashboard</a>
          <a class="list-group-item list-group-item-action" data-page="students" href="#">My Students</a>
          <a class="list-group-item list-group-item-action" data-page="attendance" href="#">Attendance</a>
          <a class="list-group-item list-group-item-action" data-page="marks" href="#">Marks</a>
          <a class="list-group-item list-group-item-action" data-page="assignments" href="#">Assignments</a>
          <a class="list-group-item list-group-item-action" data-page="submissions" href="#">Submissions</a>
          <a class="list-group-item list-group-item-action" data-page="settings" href="#">Settings</a>
        </div>
      </div>
    </aside>

    <!-- Main Area -->
    <div class="flex-fill">
      <!-- Topbar -->
      <div class="topbar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <h5 id="pageTitle" class="mb-0">Dashboard</h5>
          <div id="pageSubtitle" class="small-muted">
            Overview & quick actions
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="logout" class="btn btn-outline-secondary btn-sm">
            Logout
          </button>
        </div>
      </div>

      <!-- Page Content -->
      <div class="content">
        <!-- Dashboard Overview -->
        <div id="page-dashboard">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="tile-card">
                <h5>Total Students</h5>
                <div id="countStudents" class="h3 mt-2">—</div>
                <div class="small-muted">Students assigned to you</div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="tile-card">
                <h5>Today's Attendance</h5>
                <div id="countAttendance" class="h3 mt-2">—</div>
                <div class="small-muted">Students marked today</div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="tile-card">
                <h5>Course / Subject</h5>
                <div id="teacherSubject" class="h3 mt-2">—</div>
                <div class="small-muted">Your assigned subject & batch</div>
              </div>
            </div>
          </div>

          <!-- ======= ADDED: Compact attendance sparkline + notifications card =======
                 This block was inserted here (after the KPI tiles) — minimal, self-contained.
                 It uses your existing globals: API, token, user and the helper tryFetchAttendanceRowsForTeacher.
            -->
          <div class="row g-3 mt-3" id="dashboardWidgetsRow">
            <div class="col-md-4">
              <div class="tile-card">
                <h6>Attendance — last 7 days</h6>
                <div class="d-flex align-items-center gap-3">
                  <div>
                    <div id="attendanceAvgMini" class="h3 mb-0">—</div>
                    <div class="small-muted">Avg present</div>
                  </div>
                  <div class="attendance-chart-wrap" style="height: 140px">
                    <canvas id="attendanceChartMini"></canvas>
                  </div>
                </div>
                <div class="small-muted mt-2">
                  Click a point to open that day's attendance
                </div>
              </div>
            </div>

            <div class="col-md-8">
              <div class="tile-card">
                <h6>Notifications & Notices</h6>
                <div id="notificationsContainerMini" style="max-height: 150px; overflow: auto">
                  <div class="small-muted p-2">Loading notifications…</div>
                </div>
              </div>
            </div>
          </div>
          <!-- ======= end added block ======= -->

          <!-- Teacher XP tile -->
          <div class="col-md-8">
            <div id="teacherXPCard" class="tile-card xp-tile-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="xp-title">Teacher XP</div>
                  <div class="xp-points h2 mb-0" id="teacherXpPoints">—</div>
                  <div class="small-muted">XP points</div>
                </div>
                <div class="xp-level-meta text-end" id="teacherXpMeta">
                  Level — • —
                </div>
              </div>

              <div class="xp-bar-wrap mt-3">
                <div class="xp-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                  <div id="teacherXpBar" class="xp-progress-fill" style="width: 0%"></div>
                </div>

                <div class="xp-progress-text small-muted" id="teacherXpBarText">
                  — / — XP • —%
                </div>
              </div>

              <div class="xp-note small-muted mt-2">
                Earn XP by taking actions (attendance, marks, etc.).
              </div>
            </div>
          </div>
        </div>

        <!-- My Students -->
        <div id="page-students" class="d-none">
          <div class="card card-ghost p-3">
            <h5>My Students</h5>
            <p class="muted">
              This page shows students assigned to the teacher (by batches).
            </p>
            <div class="table-responsive mt-3">
              <table class="table">
                <thead>
                  <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Course</th>
                    <th>Batch / Year</th>
                  </tr>
                </thead>
                <tbody id="teacherStudentsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Attendance Page -->
        <div id="page-attendance" class="d-none">
          <div class="card card-ghost p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex gap-2 align-items-center">
                <label class="small-muted mb-0">Batch</label>
                <select id="attendanceBatchSelect" class="form-select form-select-sm" style="min-width: 200px">
                  <option value="">Select batch</option>
                </select>

                <label class="small-muted mb-0 ms-3">Date</label>
                <input id="attendanceDate" type="date" class="form-control form-control-sm" style="width: 160px" />
                <button id="loadAttendanceBtn" class="btn btn-outline-primary btn-sm ms-2">
                  Load
                </button>
              </div>

              <div>
                <button id="saveAttendanceBtn" class="btn btn-primary btn-sm">
                  Save Attendance
                </button>
              </div>
            </div>

            <div id="attendanceMsg" class="text-danger small mb-2"></div>

            <div id="attendanceArea">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Roll No</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th style="min-width: 170px">Present / Absent</th>
                    </tr>
                  </thead>
                  <tbody id="attendanceBody">
                    <tr>
                      <td colspan="4" class="text-muted p-3">
                        Select batch & date and click Load
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Marks Page (NEW) -->
        <div id="page-marks" class="d-none">
          <div class="card card-ghost p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-0">Marks</h5>
                <div class="marks-note">
                  Enter assessment marks for students in your batch.
                </div>
              </div>

              <div class="d-flex gap-2 align-items-center">
                <div class="marks-filters d-flex align-items-center gap-2">
                  <div>
                    <label class="small-muted mb-0">Batch</label><br />
                    <select id="marksBatchSelect" class="form-select form-select-sm" style="min-width: 220px">
                      <option value="">Select batch</option>
                    </select>
                  </div>

                  <div>
                    <label class="small-muted mb-0">Assessment</label><br />
                    <input id="marksAssessment" class="form-control form-control-sm" placeholder="e.g. Midterm 1"
                      style="min-width: 200px" />
                  </div>

                  <div>
                    <label class="small-muted mb-0">Max marks</label><br />
                    <input id="marksMax" type="number" class="form-control form-control-sm" placeholder="100"
                      style="width: 100px" min="1" />
                  </div>

                  <div>
                    <label class="small-muted mb-0">Date</label><br />
                    <input id="marksDate" type="date" class="form-control form-control-sm" style="width: 160px" />
                  </div>

                  <div style="margin-top: 22px">
                    <div class="marks-actions">
                      <button id="loadMarksBtn" class="btn btn-outline-primary btn-sm">
                        Load
                      </button>
                      <button id="saveMarksBtn" class="btn btn-primary btn-sm">
                        Save Marks
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="marksMsg" class="text-danger small mb-2"></div>

            <div id="marksArea">
              <div class="table-responsive">
                <table class="table table-hover" id="marksTable">
                  <thead>
                    <tr>
                      <th style="width: 120px">Roll No</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th style="width: 160px">Subject</th>
                      <th style="width: 120px">Marks</th>
                    </tr>
                  </thead>
                  <tbody id="marksBody">
                    <tr>
                      <td colspan="5" class="text-muted p-3">
                        Select batch and assessment, then click Load
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ================= Teacher Assignments ================= -->
        <div id="page-assignments" class="d-none">
          <div class="card card-ghost p-3">
            <h5>Assignments</h5>
            <p class="muted">Assignments by subject & batch</p>

            <button id="addAssignmentBtn" class="btn btn-primary btn-sm mb-3">
              + New Assignment
            </button>

            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Subject</th>
                    <th>Batch</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="assignmentsBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ================= Teacher Submissions Page ================= -->
        <div id="page-submissions" class="d-none">
          <div class="card card-ghost p-3">
            <h5>Assignment Submissions</h5>
            <p class="muted mb-3">
              Review student submissions, download files, and assign marks.
            </p>

            <!-- Assignment selector -->
            <div class="mb-3 d-flex align-items-center gap-2">
              <label class="small-muted mb-0">Assignment</label>
              <select id="submissionAssignmentSelect" class="form-select form-select-sm" style="max-width: 360px">
                <option value="">Select assignment</option>
              </select>
            </div>

            <!-- Submissions table -->
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Submitted At</th>
                    <th>File</th>
                    <th style="width: 120px">Marks</th>
                    <th>Feedback</th>
                    <th>Note</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="submissionsBody">
                  <tr>
                    <td colspan="7" class="text-muted p-3">
                      Select an assignment to view submissions
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ================= Teacher Settings (replace existing placeholder) ================= -->
        <div id="page-settings" class="d-none">
          <div class="card card-ghost p-3">
            <h5>Settings</h5>
            <p class="muted">
              Update profile, view College/School info & notifications.
            </p>

            <div class="mt-3">
              <div class="btn-group mb-3" role="group" aria-label="settings tabs">
                <button id="t_tabProfile" class="btn btn-outline-primary btn-sm settings-tab active">
                  My Profile
                </button>
                <button id="t_tabSchool" class="btn btn-outline-primary btn-sm settings-tab">
                  College/School Info
                </button>
                <button id="t_tabNotif" class="btn btn-outline-primary btn-sm settings-tab">
                  Notifications
                </button>
              </div>

              <div id="t_settingsContent">
                <!-- Profile Pane -->
                <div id="t_paneProfile" class="settings-pane">
                  <form id="t_profileForm">
                    <div class="mb-2">
                      <label class="form-label">Name</label>
                      <input id="t_profile_name" class="form-control" name="name" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Email (readonly)</label>
                      <input id="t_profile_email" class="form-control" readonly />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Phone</label>
                      <input id="t_profile_phone" class="form-control" name="phone" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Subject</label>
                      <input id="t_profile_subject" class="form-control" name="subject" />
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Specialization</label>
                      <input id="t_profile_specialization" class="form-control" name="specialization" />
                    </div>
                    <div id="t_profileMsg" class="text-danger small mb-2"></div>
                    <div>
                      <button id="t_profileSaveBtn" class="btn btn-primary btn-sm">
                        Save Profile
                      </button>
                    </div>
                  </form>
                </div>

                <!-- School Pane -->
                <div id="t_paneSchool" class="settings-pane" style="display: none">
                  <div id="t_schoolInfo">
                    <div class="mb-2">
                      <strong id="t_school_name">—</strong>
                    </div>
                    <div class="mb-2 small-muted" id="t_school_address"></div>
                    <div class="mb-2 small-muted">
                      Phone: <span id="t_school_phone"></span>
                    </div>
                    <div class="mb-2 small-muted">
                      Email: <span id="t_school_email"></span>
                    </div>
                    <div class="mb-2 small-muted">
                      Website: <span id="t_school_website"></span>
                    </div>
                  </div>
                </div>

                <!-- Notifications Pane -->
                <div id="t_paneNotif" class="settings-pane" style="display: none">
                  <h6>Your Notifications</h6>
                  <div id="t_notifList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- ================= end teacher settings ================= -->
        <!-- System Status Strip (fixed to bottom of page content) -->
        <div id="systemStatusStrip" class="system-status-strip">
          <div class="status-left">
            <span id="status-server">Server </span>
            <span id="status-server-value" class="status-dot checking">Checking…</span>
          </div>
          <div class="status-mid">
            <span id="status-sync">Sync</span>
            <span id="status-sync-value">—</span>
          </div>
          <div class="status-right">
            <span id="status-response">Response</span>
            <span id="status-response-value">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
      history.go(1);
    };
  </script>

  <script>
    const API = "https://campusmate-backend-3x5c.onrender.com/api";
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    const user = JSON.parse(localStorage.getItem("user") || "null");

    if (!token || role !== "teacher") {
      window.location.href = "index.html";
    }

    // Show teacher details
    document.getElementById("teacherName").innerText = user.name || "Teacher";
    document.getElementById("teacherEmail").innerText = user.email || "";

    // Page switching
    const links = document.querySelectorAll(".list-group-item[data-page]");
    links.forEach((link) =>
      link.addEventListener("click", (e) => {
        e.preventDefault();
        links.forEach((a) => a.classList.remove("active"));
        link.classList.add("active");
        const page = link.dataset.page;
        document.getElementById("pageTitle").innerText =
          page.charAt(0).toUpperCase() + page.slice(1);
        const subtitleMap = {
          dashboard: "Overview & quick actions",
          students: "Students assigned to you",
          attendance: "Mark & review attendance",
          marks: "Enter & view marks",
          settings: "Update profile & preferences",
        };
        document.getElementById("pageSubtitle").innerText = subtitleMap[page];
        document
          .querySelectorAll('[id^="page-"]')
          .forEach((p) => p.classList.add("d-none"));
        document.getElementById("page-" + page).classList.remove("d-none");

        if (page === "students") loadTeacherStudents();
        if (page === "dashboard") initDashboardWidgets();

        // When attendance page clicked, ensure batches are loaded
        if (page === "attendance") {
          if (typeof loadTeacherBatchesForSelect === "function") {
            loadTeacherBatchesForSelect();
          }
        }

        // When marks page clicked, initialize marks page controls
        if (page === "marks") {
          initMarksPage().catch((e) =>
            console.warn("initMarksPage failed", e),
          );
        }
        // when marks page opens, populate marks batch select
        if (page === "marks") {
          if (typeof loadTeacherBatchesForSelect === "function") {
            loadTeacherBatchesForSelect().catch((e) =>
              console.warn("loadTeacherBatchesForSelect failed for marks", e),
            );
          }
        }

        if (page === "assignments") loadTeacherAssignments();
        if (page === "submissions") {
          initSubmissionsPage();
        }
      }),
    );

    async function loadTeacherStudents() {
      try {
        const res = await fetch(API + `/teachers/${user.id}/students`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          document.getElementById("teacherStudentsBody").innerHTML =
            '<tr><td colspan="5" class="text-danger p-3">Unable to load</td></tr>';
          return;
        }
        const students = await res.json();
        const tbody = document.getElementById("teacherStudentsBody");
        tbody.innerHTML = "";
        students.forEach((s) => {
          const batchText = s.std || "";
          const yearText = s.batch_year || s.year || "";
          const batchYear = batchText
            ? batchText + (yearText ? " / " + yearText : "")
            : yearText
              ? String(yearText)
              : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(s.roll_no)}</td>
                        <td>${escapeHtml(s.name)}</td>
                        <td>${escapeHtml(s.email || "")}</td>
                        <td>${escapeHtml(s.course || "")}</td>
                        <td>${escapeHtml(batchYear)}</td>`;
          tbody.appendChild(tr);
        });
        document.getElementById("countStudents").innerText =
          students.length || "—";
      } catch (err) {
        console.error("loadTeacherStudents", err);
      }
    }

    // helper that tries multiple attendance endpoints and returns rows array or null
    async function tryFetchAttendanceRowsForTeacher(date, batchId = null) {
      // prefer teacher-scoped endpoint with batch_id (backend expects batch_id)
      const tries = [
        {
          url: `${API}/teachers/${user.id
            }/attendance?date=${encodeURIComponent(date)}${batchId ? "&batch_id=" + encodeURIComponent(batchId) : ""
            }`,
          label: "teachers/:id/attendance",
        },
        {
          url: `${API}/attendance?date=${encodeURIComponent(
            date,
          )}&teacher_id=${encodeURIComponent(user.id)}`,
          label: "attendance?teacher_id",
        },
        {
          url: `${API}/attendance?date=${encodeURIComponent(date)}${batchId ? "&batch_id=" + encodeURIComponent(batchId) : ""
            }`,
          label: "attendance?date",
        },
      ];

      for (const t of tries) {
        try {
          console.debug("Trying attendance endpoint:", t.label, t.url);
          const res = await fetch(t.url, {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            console.warn(
              `Attendance endpoint ${t.label} returned status`,
              res.status,
            );
            continue;
          }
          const rows = await res.json();
          if (Array.isArray(rows)) {
            console.debug(
              "Attendance rows obtained from",
              t.label,
              rows.length,
              "rows",
            );
            return rows;
          } else {
            console.warn(
              "Attendance endpoint",
              t.label,
              "returned non-array:",
              rows,
            );
            continue;
          }
        } catch (err) {
          console.warn("Attempt failed for", t.label, err);
          continue;
        }
      }
      // none worked
      return null;
    }

    /* ---------- Attendance UI logic (modified to Present / Absent buttons) ---------- */

    async function loadTeacherBatchesForSelect() {
      try {
        const res = await fetch(API + `/teachers/${user.id}/batches`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) return;
        const obj = await res.json(); // { batchIds: [...] }
        const batchIds = obj.batchIds || [];

        // get full batch details
        if (!batchIds.length) {
          const sel = document.getElementById("attendanceBatchSelect");
          if (sel) sel.innerHTML = '<option value="">Select batch</option>';
          const marksSel = document.getElementById("marksBatchSelect");
          if (marksSel)
            marksSel.innerHTML = '<option value="">Select batch</option>';
          return; // no assigned batches
        }

        const allRes = await fetch(API + "/batches", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!allRes.ok) return;
        const all = await allRes.json(); // array of batches
        const mine = all.filter((b) => batchIds.includes(b.id));

        // populate attendance select
        const sel = document.getElementById("attendanceBatchSelect");
        if (sel) {
          sel.innerHTML = '<option value="">Select batch</option>';
          for (const b of mine) {
            const txt = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
              }`;
            const opt = document.createElement("option");
            opt.value = b.id;
            opt.innerText = txt;
            sel.appendChild(opt);
          }
          // default to first assigned batch
          if (!sel.value && mine.length) sel.value = mine[0].id;
        }

        // populate marks select (if present)
        const marksSel = document.getElementById("marksBatchSelect");
        if (marksSel) {
          marksSel.innerHTML = '<option value="">Select batch</option>';
          for (const b of mine) {
            const txt = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
              }`;
            const opt = document.createElement("option");
            opt.value = b.id;
            opt.innerText = txt;
            marksSel.appendChild(opt);
          }
          // default to first assigned batch
          if (!marksSel.value && mine.length) marksSel.value = mine[0].id;
        }

        // default date for attendance input if empty
        const d = document.getElementById("attendanceDate");
        if (d && !d.value) d.value = localDateISO();
      } catch (err) {
        console.error("loadTeacherBatchesForSelect", err);
      }
    }

    document
      .getElementById("loadAttendanceBtn")
      .addEventListener("click", () => {
        loadAttendanceForDate();
      });

    async function loadAttendanceForDate() {
      const batchId = document.getElementById("attendanceBatchSelect").value;
      const date =
        document.getElementById("attendanceDate").value ||
        new Date().toISOString().slice(0, 10);
      const msgEl = document.getElementById("attendanceMsg");
      msgEl.innerText = "";
      if (!batchId) {
        msgEl.innerText = "Select a batch first";
        return;
      }
      if (!date) {
        msgEl.innerText = "Select a date";
        return;
      }

      // Load students assigned to teacher for this batch
      try {
        // API: GET /teachers/:id/students?batch_id=...&date=...
        const res = await fetch(
          API +
          `/teachers/${user.id}/students?batch_id=${batchId}&date=${date}`,
          { headers: { Authorization: "Bearer " + token } },
        );
        if (!res.ok) {
          msgEl.innerText = "Failed to load students";
          return;
        }
        const students = await res.json(); // each student may have attendance property if backend provided
        // Try to get existing attendance rows separately (endpoint)
        let attendanceMap = {};
        // Use the helper that tries typical attendance endpoints (prefers teacher endpoint with batch_id)
        try {
          const aRows = await tryFetchAttendanceRowsForTeacher(date, batchId);
          if (Array.isArray(aRows)) {
            for (const a of aRows) {
              // some endpoints include student_id, some may include batch_id - we guard by comparing batch if provided
              if (a.student_id) attendanceMap[a.student_id] = a.status;
            }
          } else {
            // attempt a batch-specific attendance query if helper failed
            try {
              const alt = await fetch(
                API +
                `/attendance?date=${encodeURIComponent(
                  date,
                )}&batch_id=${encodeURIComponent(batchId)}`,
                { headers: { Authorization: "Bearer " + token } },
              );
              if (alt.ok) {
                const altRows = await alt.json();
                if (Array.isArray(altRows)) {
                  for (const a of altRows) {
                    if (a.student_id) attendanceMap[a.student_id] = a.status;
                  }
                }
              }
            } catch (e) {
              // ignore - fallback to empty map
            }
          }
        } catch (e) {
          console.warn("attendance rows fetch failed:", e);
        }

        const tbody = document.getElementById("attendanceBody");
        tbody.innerHTML = "";
        if (!students.length) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="text-muted p-3">No students in this batch</td></tr>';
          return;
        }

        for (const s of students) {
          const status = attendanceMap[s.id] || s.attendance || "Absent"; // default to Absent
          const isPresent = String(status).toLowerCase() === "present";
          const isAbsent = !isPresent;

          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(s.roll_no || "")}</td>
                      <td>${escapeHtml(s.name || "")}</td>
                      <td>${escapeHtml(s.email || "")}</td>
                      <td><div class="att-actions" data-student="${s.id}">
                          <button type="button" class="att-btn present ${isPresent ? "active" : ""
            }" title="Present">
                            P <span class="icon">✓</span>
                          </button>
                          <button type="button" class="att-btn absent ${isAbsent ? "active" : ""
            }" title="Absent">
                            A <span class="icon">✕</span>
                          </button>
                        </div></td>`;
          tbody.appendChild(tr);
        }

        // attach listeners for the freshly added buttons
        document
          .querySelectorAll("#attendanceBody .att-actions")
          .forEach((wrap) => {
            const presentBtn = wrap.querySelector(".att-btn.present");
            const absentBtn = wrap.querySelector(".att-btn.absent");
            // replace nodes to clear old listeners
            const pClone = presentBtn.cloneNode(true);
            const aClone = absentBtn.cloneNode(true);
            presentBtn.replaceWith(pClone);
            absentBtn.replaceWith(aClone);

            pClone.addEventListener("click", () => {
              pClone.classList.add("active");
              aClone.classList.remove("active");
            });
            aClone.addEventListener("click", () => {
              aClone.classList.add("active");
              pClone.classList.remove("active");
            });
          });

        // default today's date in input
        document.getElementById("attendanceDate").value = date;

        // update dashboard counts after loading attendance so dashboard shows current info
        await initDashboardWidgets();
      } catch (err) {
        console.error("loadAttendanceForDate", err);
        document.getElementById("attendanceMsg").innerText = "Server error";
      }
    }

    document
      .getElementById("saveAttendanceBtn")
      .addEventListener("click", async () => {
        const btn = document.getElementById("saveAttendanceBtn");
        const batchId = document.getElementById(
          "attendanceBatchSelect",
        ).value;
        const date =
          document.getElementById("attendanceDate").value || localDateISO();
        const msgEl = document.getElementById("attendanceMsg");
        msgEl.innerText = "";
        if (!batchId) {
          msgEl.innerText = "Select a batch first";
          return;
        }
        // collect records
        const actionRows = Array.from(
          document.querySelectorAll("#attendanceBody .att-actions"),
        );
        if (!actionRows.length) {
          msgEl.innerText = "No students loaded";
          return;
        }
        const records = actionRows.map((wrap) => {
          const sid = Number(wrap.dataset.student);
          const presentBtn = wrap.querySelector(".att-btn.present");
          const status =
            presentBtn && presentBtn.classList.contains("active")
              ? "Present"
              : "Absent";
          return {
            student_id: sid,
            status,
          };
        });

        // disable button while saving
        btn.setAttribute("disabled", "disabled");
        const spinner = document.createElement("span");
        spinner.className = "spinner-border spinner-border-sm ms-2";
        spinner.setAttribute("role", "status");
        spinner.ariaHidden = "true";
        btn.appendChild(spinner);

        try {
          const res = await fetch(API + `/teachers/${user.id}/attendance`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              date,
              batch_id: Number(batchId),
              records,
            }),
          });
          const data = await res
            .json()
            .catch(() => ({ message: "Server error" }));
          if (!res.ok) {
            msgEl.innerText = data.message || "Failed to save";
            return;
          }
          // success
          if (typeof showToast === "function") showToast("Attendance saved");
          else alert("Attendance saved");

          // refresh stats (small delay)
          setTimeout(() => initDashboardWidgets().catch(() => { }), 200);
        } catch (err) {
          console.error("saveAttendance", err);
          msgEl.innerText = "Server error";
        } finally {
          btn.removeAttribute("disabled");
          const s = btn.querySelector(".spinner-border");
          if (s) s.remove();
        }
      });

    // MARKS: teacher-side marks UI logic

    // Called when the Marks page is shown (ensures batch select is populated)
    async function initMarksPage() {
      // populate batch select for teacher (reuses existing function)
      if (typeof loadTeacherBatchesForSelect === "function") {
        await loadTeacherBatchesForSelect();
      }

      // set default date to today if empty
      const d = document.getElementById("marksDate");
      if (d && !d.value) d.value = localDateISO();

      // attach events (only once)
      const loadBtn = document.getElementById("loadMarksBtn");
      const saveBtn = document.getElementById("saveMarksBtn");
      if (loadBtn && !loadBtn._bound) {
        loadBtn.addEventListener("click", loadMarksForAssessment);
        loadBtn._bound = true;
      }
      if (saveBtn && !saveBtn._bound) {
        saveBtn.addEventListener("click", saveMarks);
        saveBtn._bound = true;
      }
    }

    // Loads students for chosen batch and attempts to prefill any existing marks
    async function loadMarksForAssessment() {
      const msgEl = document.getElementById("marksMsg");
      msgEl.innerText = "";
      const batchId = document.getElementById("marksBatchSelect").value;
      const assessment = document
        .getElementById("marksAssessment")
        .value.trim();
      const date =
        document.getElementById("marksDate").value ||
        new Date().toISOString().slice(0, 10);

      if (!batchId) {
        msgEl.innerText = "Select a batch first";
        return;
      }
      if (!assessment) {
        msgEl.innerText = "Enter assessment name";
        return;
      }

      const tbody = document.getElementById("marksBody");
      tbody.innerHTML =
        '<tr><td colspan="5" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</td></tr>';

      try {
        // 1) fetch students in batch (teacher-scoped)
        const sres = await fetch(
          API +
          `/teachers/${user.id}/students?batch_id=${encodeURIComponent(
            batchId,
          )}`,
          {
            headers: { Authorization: "Bearer " + token },
          },
        );
        if (!sres.ok) {
          msgEl.innerText = "Failed to load students";
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-danger p-3">Unable to load students</td></tr>';
          return;
        }
        const students = await sres.json();

        // 2) try to fetch existing marks for this assessment (backend may provide)
        // Try teacher-scoped endpoint first: GET /teachers/:id/marks?batch_id=...&date=...&assessment=...
        let marksMap = {};
        try {
          const q = `${API}/teachers/${user.id
            }/marks?batch_id=${encodeURIComponent(
              batchId,
            )}&date=${encodeURIComponent(date)}&assessment=${encodeURIComponent(
              assessment,
            )}`;
          const mres = await fetch(q, {
            headers: { Authorization: "Bearer " + token },
          });
          if (mres.ok) {
            const mrows = await mres.json(); // expected [{ student_id, marks, subject, max_marks, comment }]
            if (Array.isArray(mrows)) {
              for (const r of mrows) {
                if (r.student_id) marksMap[r.student_id] = r;
              }
            }
          } else {
            // it's okay if server does not support this endpoint, we'll let teacher enter new marks
            console.debug("marks GET returned", mres.status);
          }
        } catch (e) {
          console.warn("fetch-existing-marks failed", e);
        }

        // --- NEW: If teacher-scoped marks returned empty but there are students in batch,
        // try fallback to the generic /marks endpoint (so teacher can view marks recorded by others for their batch).
        // This keeps all existing behavior but ensures teachers can see saved marks even when recorded_by != teacher.
        if (Object.keys(marksMap).length === 0) {
          try {
            const fallbackUrl = `${API}/marks?batch_id=${encodeURIComponent(
              batchId,
            )}&date=${encodeURIComponent(
              date,
            )}&assessment=${encodeURIComponent(assessment)}`;
            const fres = await fetch(fallbackUrl, {
              headers: { Authorization: "Bearer " + token },
            });
            if (fres.ok) {
              const frows = await fres.json();
              if (Array.isArray(frows) && frows.length) {
                for (const r of frows) {
                  if (r.student_id) marksMap[r.student_id] = r;
                }
              }
            } else {
              console.debug("fallback /marks returned", fres.status);
            }
          } catch (fe) {
            console.warn("fallback fetch /marks failed", fe);
          }
        }

        // Render table rows
        if (!Array.isArray(students) || students.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-muted p-3">No students in this batch</td></tr>';
          return;
        }

        tbody.innerHTML = "";
        // sort students by roll_no numerically if possible
        students.sort((a, b) => {
          const ra = a && a.roll_no ? String(a.roll_no).trim() : "";
          const rb = b && b.roll_no ? String(b.roll_no).trim() : "";
          const na = Number(ra);
          const nb = Number(rb);
          if (Number.isFinite(na) && Number.isFinite(nb)) return na - nb;
          return ra.localeCompare(rb, undefined, {
            numeric: true,
            sensitivity: "base",
          });
        });

        const maxInput = document.getElementById("marksMax");
        const configuredMax =
          maxInput && Number(maxInput.value) ? Number(maxInput.value) : null;

        for (const s of students) {
          const existing = marksMap[s.id] || null;
          const initialMarks =
            existing && typeof existing.marks !== "undefined"
              ? existing.marks
              : "";
          const initialSubject =
            existing && typeof existing.subject !== "undefined"
              ? existing.subject
              : "";
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${escapeHtml(s.roll_no || "")}</td>
                            <td>${escapeHtml(s.name || "")}</td>
                            <td>${escapeHtml(s.email || "")}</td>
                            <td><input data-student="${s.id
            }" class="form-control form-control-sm subject-input" type="text" placeholder="Subject" value="${escapeHtml(
              initialSubject,
            )}" /></td>
                            <td><input data-student="${s.id
            }" type="number" class="form-control form-control-sm marks-input" value="${escapeHtml(
              initialMarks,
            )}" ${configuredMax
              ? 'min="0" max="' + String(configuredMax) + '"'
              : 'min="0"'
            } /></td>`;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("loadMarksForAssessment", err);
        msgEl.innerText = "Server error";
        document.getElementById("marksBody").innerHTML =
          '<tr><td colspan="5" class="text-danger p-3">Server error</td></tr>';
      }
    }

    // Collect marks inputs and post to backend
    async function saveMarks() {
      const msgEl = document.getElementById("marksMsg");
      msgEl.innerText = "";
      const batchId = document.getElementById("marksBatchSelect").value;
      const assessment = document
        .getElementById("marksAssessment")
        .value.trim();
      const date =
        document.getElementById("marksDate").value ||
        new Date().toISOString().slice(0, 10);
      const maxMarksInput = document.getElementById("marksMax").value;
      const maxMarks = maxMarksInput ? Number(maxMarksInput) : null;

      if (!batchId) {
        msgEl.innerText = "Select a batch first";
        return;
      }
      if (!assessment) {
        msgEl.innerText = "Enter assessment name";
        return;
      }

      const inputs = Array.from(document.querySelectorAll(".marks-input"));
      if (!inputs.length) {
        msgEl.innerText = "No students loaded";
        return;
      }

      // Utility: try to parse "Semester N" -> N, fallback null
      function parseSemesterFromAssessment(str) {
        if (!str) return null;
        const m = str.match(/semester\s*(\d+)/i);
        if (m && m[1]) return Number(m[1]);
        return null;
      }
      const semester = parseSemesterFromAssessment(assessment);

      const records = [];
      for (const inp of inputs) {
        const sid = Number(inp.dataset.student);
        const subjInput = document.querySelector(
          `.subject-input[data-student="${sid}"]`,
        );
        const subjectText = subjInput
          ? String(subjInput.value || "").trim()
          : null;
        const valRaw = inp.value === "" ? "" : inp.value;
        if (valRaw === "") {
          // send null for marks but include subject if present
          records.push({
            student_id: sid,
            subject: subjectText || null,
            marks: null,
            semester,
            recorded_by: Number(user.id),
          });
          continue;
        }
        const num = Number(valRaw);
        if (Number.isNaN(num)) {
          msgEl.innerText = "Please enter valid numeric marks";
          return;
        }
        if (maxMarks !== null && (num < 0 || num > maxMarks)) {
          msgEl.innerText = `Marks must be between 0 and ${maxMarks}`;
          return;
        }
        records.push({
          student_id: sid,
          subject: subjectText || null,
          marks: num,
          semester,
          recorded_by: Number(user.id),
        });
      }

      // disable save button & show spinner
      const btn = document.getElementById("saveMarksBtn");
      btn.setAttribute("disabled", "disabled");
      const spinner = document.createElement("span");
      spinner.className = "spinner-border spinner-border-sm ms-2";
      spinner.setAttribute("role", "status");
      spinner.ariaHidden = "true";
      btn.appendChild(spinner);

      // payload top-level (some backends accept top-level recorded_by etc)
      const payload = {
        date,
        batch_id: Number(batchId),
        assessment,
        max_marks: maxMarks,
        records,
      };

      // helper to attempt a POST and return {ok, status, bodyText}
      async function tryPost(url) {
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify(payload),
          });
          const text = await res.text().catch(() => "");
          // attempt to parse json for nicer console logging
          let body = text;
          try {
            body = JSON.parse(text);
          } catch (e) { }
          return { ok: res.ok, status: res.status, body, raw: text };
        } catch (err) {
          return {
            ok: false,
            status: 0,
            body: String(err),
            raw: String(err),
          };
        }
      }

      try {
        // First try the generic endpoint that matches DB table (/marks)
        // ALWAYS use teacher route so XP is awarded
        let attempt = await tryPost(API + `/teachers/${user.id}/marks`);
        console.debug(
          `POST /teachers/${user.id}/marks ->`,
          attempt.status,
          attempt.body,
        );

        if (!attempt.ok) {
          msgEl.innerText = attempt.body.message || "Failed to save marks";
          return;
        }

        if (!attempt.ok) {
          // show server's message if available
          if (attempt.body && attempt.body.message)
            msgEl.innerText = attempt.body.message;
          else
            msgEl.innerText = `Failed to save marks (status ${attempt.status}). Check server logs / response in console.`;
          console.error("saveMarks failed response:", attempt);
          return;
        }

        // success
        if (typeof showToast === "function") showToast("Marks saved");
        else alert("Marks saved");
        // attempt to reload existing marks to confirm saved state
        setTimeout(() => loadMarksForAssessment().catch(() => { }), 300);
      } catch (err) {
        console.error("saveMarks unexpected error", err);
        msgEl.innerText = "Server error";
      } finally {
        btn.removeAttribute("disabled");
        const s = btn.querySelector(".spinner-border");
        if (s) s.remove();
      }
    }

    // When attendance page opens we populate batch select for teacher
    // Ensure loadTeacherBatchesForSelect() is called on initial load and whenever page opened.
    if (typeof loadTeacherBatchesForSelect === "function") {
      loadTeacherBatchesForSelect();
    }

    function escapeHtml(text = "") {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    // Teacher Assignments page and logic
    let assignmentToDeleteId = null;
    let editingAssignmentId = null;
    async function loadTeacherAssignments() {
      try {
        const res = await fetch(API + `/assignments/teacher/${user.id}`, {
          headers: { Authorization: "Bearer " + token },
        });

        if (!res.ok) return;

        const list = await res.json();
        const tbody = document.getElementById("assignmentsBody");
        tbody.innerHTML = "";

        if (!list.length) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-muted p-3">No assignments yet</td></tr>';
          return;
        }

        list.forEach((a) => {
          const batchText = `${a.course || ""} ${a.batch || ""}${a.year ? " (" + a.year + ")" : ""}`;

          const tr = document.createElement("tr");

          // --- text columns ---
          tr.innerHTML = `
        <td>${escapeHtml(a.title)}</td>
        <td>${escapeHtml(a.subject)}</td>
        <td>${escapeHtml(batchText)}</td>
        <td>${a.due_date ? formatDateOnly(a.due_date) : "—"}</td>
      `;

          // --- actions column ---
          const actionsTd = document.createElement("td");

          const editBtn = document.createElement("button");
          editBtn.className = "btn btn-sm btn-outline-primary me-2";
          editBtn.innerText = "Edit";
          editBtn.addEventListener("click", () => openEditAssignment(a));

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-danger";
          delBtn.innerText = "Delete";
          delBtn.addEventListener("click", () =>
            openDeleteAssignmentModal(a.id),
          );

          actionsTd.appendChild(editBtn);
          actionsTd.appendChild(delBtn);

          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("loadTeacherAssignments", err);
      }
    }

    function formatDateOnly(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return "—";

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");

      return `${yyyy}-${mm}-${dd}`;
    }

    document
      .getElementById("addAssignmentBtn")
      .addEventListener("click", async () => {
        editingAssignmentId = null;

        document.getElementById("addAssignmentForm").reset();
        document.getElementById("assignmentMsg").innerText = "";

        document.querySelector("#addAssignmentModal .modal-title").innerText =
          "New Assignment";

        await loadTeacherBatchesForAssignment();

        new bootstrap.Modal(
          document.getElementById("addAssignmentModal"),
        ).show();
      });

    async function loadTeacherBatchesForAssignment() {
      const select = document.getElementById("assignmentBatch");
      select.innerHTML = '<option value="">Select batch</option>';

      try {
        const res = await fetch(API + `/teachers/${user.id}/batches`, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) return;

        const { batchIds } = await res.json();
        if (!batchIds.length) return;

        const allRes = await fetch(API + "/batches", {
          headers: { Authorization: "Bearer " + token },
        });
        if (!allRes.ok) return;

        const all = await allRes.json();
        const mine = all.filter((b) => batchIds.includes(b.id));

        mine.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.innerText = `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("loadTeacherBatchesForAssignment", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const saveBtn = document.getElementById("saveAssignmentBtn");
      if (!saveBtn) {
        console.warn("saveAssignmentBtn not found");
        return;
      }

      saveBtn.addEventListener("click", async () => {
        const batch_id = document.getElementById("assignmentBatch").value;
        const subject = document
          .getElementById("assignmentSubject")
          .value.trim();
        const title = document.getElementById("assignmentTitle").value.trim();
        const description = document
          .getElementById("assignmentDescription")
          .value.trim();
        const due_date = document.getElementById("assignmentDueDate").value;

        const msg = document.getElementById("assignmentMsg");
        msg.innerText = "";

        if (!batch_id || !subject || !title) {
          msg.innerText = "Batch, Subject and Title are required";
          return;
        }

        try {
          const url = editingAssignmentId
            ? API + "/assignments/" + editingAssignmentId
            : API + "/assignments";

          const method = editingAssignmentId ? "PUT" : "POST";

          const res = await fetch(url, {
            method,
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              batch_id,
              subject,
              title,
              description,
              due_date,
            }),
          });

          const data = await res.json();

          if (!res.ok) {
            msg.innerText = data.message || "Failed to save";
            return;
          }

          bootstrap.Modal.getInstance(
            document.getElementById("addAssignmentModal"),
          ).hide();

          showToast(
            editingAssignmentId
              ? "Assignment updated Successfully"
              : "Assignment created Successfully",
          );

          loadTeacherAssignments();
        } catch (err) {
          console.error("saveAssignment", err);
          msg.innerText = "Server error";
        }
      });
    });

    async function openEditAssignment(a) {
      editingAssignmentId = a.id;

      // 1️ Load batch options FIRST
      await loadTeacherBatchesForAssignment();

      // 2️Now safely set values
      document.getElementById("assignmentBatch").value = String(a.batch_id);
      document.getElementById("assignmentSubject").value = a.subject || "";
      document.getElementById("assignmentTitle").value = a.title || "";
      document.getElementById("assignmentDescription").value =
        a.description || "";
      document.getElementById("assignmentDueDate").value = a.due_date
        ? formatDateOnly(a.due_date)
        : "";

      // 3️ Update modal title
      document.querySelector("#addAssignmentModal .modal-title").innerText =
        "Edit Assignment";

      // 4️ Show modal
      new bootstrap.Modal(
        document.getElementById("addAssignmentModal"),
      ).show();
    }

    function openDeleteAssignmentModal(id) {
      assignmentToDeleteId = id;

      new bootstrap.Modal(
        document.getElementById("deleteAssignmentModal"),
      ).show();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const delBtn = document.getElementById("confirmDeleteAssignmentBtn");

      if (!delBtn) {
        console.warn("confirmDeleteAssignmentBtn not found");
        return;
      }

      delBtn.addEventListener("click", async () => {
        if (!assignmentToDeleteId) return;

        try {
          const res = await fetch(
            API + "/assignments/" + assignmentToDeleteId,
            {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + token,
              },
            },
          );

          if (!res.ok) {
            alert("Failed to delete assignment");
            return;
          }

          bootstrap.Modal.getInstance(
            document.getElementById("deleteAssignmentModal"),
          ).hide();

          showToast("Assignment deleted");

          assignmentToDeleteId = null;
          loadTeacherAssignments();
        } catch (err) {
          console.error("deleteAssignment", err);
        }
      });
    });

    // Submissions page logic
    async function initSubmissionsPage() {
      const select = document.getElementById("submissionAssignmentSelect");
      const tbody = document.getElementById("submissionsBody");

      // reset UI
      select.innerHTML = `<option value="">Select assignment</option>`;
      tbody.innerHTML = `
    <tr>
      <td colspan="7" class="text-muted p-3">
        Select an assignment to view submissions
      </td>
    </tr>
  `;

      try {
        const res = await fetch(API + `/assignments/teacher/${user.id}`, {
          headers: { Authorization: "Bearer " + token },
        });

        if (!res.ok) {
          select.innerHTML = `<option value="">Failed to load assignments</option>`;
          return;
        }

        const list = await res.json();

        if (!list.length) {
          select.innerHTML = `<option value="">No assignments found</option>`;
          return;
        }

        list.forEach((a) => {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = `${a.title} (${a.subject})`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("initSubmissionsPage", err);
        select.innerHTML = `<option value="">Server error</option>`;
      }
    }

    async function loadSubmissionsForAssignment(assignmentId) {
      const tbody = document.getElementById("submissionsBody");

      tbody.innerHTML = `
    <tr>
      <td colspan="7" class="text-muted p-3">Loading submissions...</td>
    </tr>
  `;

      try {
        const res = await fetch(
          API + `/assignments/${assignmentId}/submissions`,
          {
            headers: { Authorization: "Bearer " + token },
          },
        );

        if (!res.ok) {
          tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-danger p-3">
            Failed to load submissions
          </td>
        </tr>
      `;
          return;
        }

        const list = await res.json();

        list.sort((a, b) => {
          const ra = Number(a.roll_no);
          const rb = Number(b.roll_no);

          if (!isNaN(ra) && !isNaN(rb)) return ra - rb;
          return String(a.roll_no).localeCompare(String(b.roll_no), undefined, {
            numeric: true,
            sensitivity: "base",
          });
        });

        tbody.innerHTML = "";
        if (!list.length) {
          tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-muted p-3">
            No students found
          </td>
        </tr>
      `;
          return;
        }

        list.forEach((s) => {
          const tr = document.createElement("tr");

          const submitted = !!s.submitted_at;
          const reviewed = s.marks !== null;

          tr.innerHTML = `
            <td>${s.roll_no || "-"}</td>
            <td>${s.name}</td>
            <td>${submitted ? formatDateOnly(s.submitted_at) : "—"}</td>
            <td>
              ${submitted && s.file_path
              ? `<a href="${API.replace("/api", "")}/uploads/assignments/${s.file_path}"
                    target="_blank"
                    class="btn btn-sm btn-outline-info">
                    Download
                  </a>`
              : "—"
            }
            </td>
            <td>
              <input type="number"
                class="form-control form-control-sm marks-input"
                min="0" max="10"
                value="${s.marks ?? ""}"
                ${!submitted || reviewed ? "disabled" : ""}>
            </td>
            <td>
              <input type="text"
                class="form-control form-control-sm feedback-input"
                value="${s.feedback ?? ""}"
                ${!submitted || reviewed ? "disabled" : ""}>
            </td>
            <td>
              ${s.submission_text
              ? `<button class="btn btn-sm btn-outline-secondary note-btn">
                    View
                  </button>`
              : "—"
            }
            </td>
            <td>
              ${reviewed
              ? `<button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>`
              : `<button class="btn btn-sm btn-success save-btn"
                  ${!submitted ? "disabled" : ""}>
                  Save
                </button>`
            }
            </td>
          `;

          tbody.appendChild(tr);
          attachNoteHandler(tr, s);
          attachSaveHandler(tr, s);
          attachEditHandler(tr, s);
        });

      } catch (err) {
        console.error("loadSubmissionsForAssignment", err);
        tbody.innerHTML = `
      <tr>
        <td colspan="7" class="text-danger p-3">
          Server error
        </td>
      </tr>
    `;
      }
    }

    // Attach Note button handler
    function attachNoteHandler(tr, s) {
      const btn = tr.querySelector(".note-btn");
      if (!btn) return;

      btn.addEventListener("click", () => {
        document.getElementById("noteStudentName").innerText = s.name;
        document.getElementById("noteContent").innerText =
          s.submission_text || "—";

        new bootstrap.Modal(
          document.getElementById("submissionNoteModal")
        ).show();
      });
    }

    // Attach save button handler for a submission row
    function attachSaveHandler(tr, s) {
      const saveBtn = tr.querySelector(".save-btn");
      if (!saveBtn) return;

      saveBtn.addEventListener("click", async () => {
        const marksInput = tr.querySelector(".marks-input");
        const feedbackInput = tr.querySelector(".feedback-input");

        const marksRaw = marksInput.value.trim();
        const feedbackRaw = feedbackInput.value.trim();

        if (marksRaw === "" || feedbackRaw === "") {
          showTeacherToast(
            "Marks and feedback are required before saving",
            "warning"
          );
          return;
        }

        const marks = Number(marksRaw);
        if (isNaN(marks) || marks < 0 || marks > 10) {
          showTeacherToast(
            "Marks must be between 0 and 10",
            "danger"
          );
          return;
        }

        const res = await fetch(
          API + `/assignments/submissions/${s.submission_id}/review`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + token,
            },
            body: JSON.stringify({
              marks,
              feedback: feedbackRaw,
            }),
          }
        );

        if (!res.ok) {
          showTeacherToast("Failed to save review", "danger");
          return;
        }

        marksInput.disabled = true;
        feedbackInput.disabled = true;

        const actionTd = saveBtn.parentElement;
        actionTd.innerHTML = `
      <button class="btn btn-sm btn-outline-primary edit-btn">
        Edit
      </button>
    `;

        const editBtn = actionTd.querySelector(".edit-btn");
        editBtn.addEventListener("click", () => {
          marksInput.disabled = false;
          feedbackInput.disabled = false;

          actionTd.innerHTML = `
        <button class="btn btn-sm btn-success save-btn">
          Save
        </button>
      `;
          attachSaveHandler(tr, s);
          showTeacherToast("Editing enabled", "dark");
        });

        showTeacherToast("Review saved successfully", "success");
      });
    }

    function attachEditHandler(tr, s) {
      const editBtn = tr.querySelector(".edit-btn");
      if (!editBtn) return;

      editBtn.addEventListener("click", () => {
        const marksInput = tr.querySelector(".marks-input");
        const feedbackInput = tr.querySelector(".feedback-input");

        marksInput.disabled = false;
        feedbackInput.disabled = false;

        const actionTd = editBtn.parentElement;
        actionTd.innerHTML = `
      <button class="btn btn-sm btn-success save-btn">
        Save
      </button>
    `;

        attachSaveHandler(tr, s);
        showTeacherToast("Editing enabled", "dark");
      });
    }


    document
      .getElementById("submissionAssignmentSelect")
      .addEventListener("change", (e) => {
        const assignmentId = e.target.value;
        if (!assignmentId) return;

        loadSubmissionsForAssignment(assignmentId);
      });

    /* ---------- UX helpers: validation, toast, disable ---------- */

    // Show bootstrap toast with message
    function showToast(message) {
      const body = document.getElementById("appToastBody");
      const toastEl = document.getElementById("appToast");
      body.innerText = message;
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }

    // Enable / disable button and optionally show spinner inside
    function setButtonLoading(btnEl, isLoading) {
      if (!btnEl) return;
      if (isLoading) {
        btnEl.setAttribute("disabled", "disabled");
        // add spinner if none
        if (!btnEl.querySelector(".btn-spinner")) {
          const sp = document.createElement("span");
          sp.className = "spinner-border spinner-border-sm btn-spinner ms-2";
          sp.role = "status";
          sp.ariaHidden = "true";
          btnEl.appendChild(sp);
        }
      } else {
        btnEl.removeAttribute("disabled");
        const sp = btnEl.querySelector(".btn-spinner");
        if (sp) sp.remove();
      }
    }

    /* ---------- Form validators ---------- */

    // Student form validator: returns { ok: boolean, fields: { field: msg } }
    function validateStudentForm({ roll_no, name, course, year }) {
      const fields = {};
      if (!roll_no || !/^[A-Za-z0-9-]{2,30}$/.test(roll_no)) {
        fields.roll_no = "Roll number required (alpha-numeric, 2-30 chars)";
      }
      if (!name || name.length < 3)
        fields.name = "Full name required (min 3 chars)";
      if (!course) fields.course = "Select a course";
      if (year) {
        const y = Number(year);
        if (!Number.isInteger(y) || y < 2000 || y > 2100)
          fields.year = "Enter a valid year (e.g. 2025)";
      }
      return { ok: Object.keys(fields).length === 0, fields };
    }

    // Teacher form validator
    function validateTeacherForm({ name, email }) {
      const fields = {};
      if (!name || name.length < 3) fields.name = "Full name required";
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email))
        fields.email = "Valid email required";
      return { ok: Object.keys(fields).length === 0, fields };
    }

    // Display inline field errors (form = parent element, errorObj = { field: msg })
    function showInlineErrors(formEl, errorObj) {
      // clear previous
      formEl.querySelectorAll(".field-error").forEach((e) => e.remove());
      for (const [field, msg] of Object.entries(errorObj)) {
        const inp = formEl.querySelector(`#${field}`);
        if (inp) {
          const div = document.createElement("div");
          div.className = "field-error text-danger small mt-1";
          div.innerText = msg;
          inp.insertAdjacentElement("afterend", div);
        } else {
          // fallback toast
          showToast(msg);
        }
      }
    }
  </script>

  <script>
    (function () {
      const API = "https://campusmate-backend-3x5c.onrender.com/api";
      const API_BASE = API;
      const token = localStorage.getItem("token");

      function escapeHtml(s = "") {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function showToastSafe(msg) {
        if (typeof showToast === "function") showToast(msg);
        else console.log(msg);
      }

      const tabProfile = document.getElementById("t_tabProfile");
      const tabSchool = document.getElementById("t_tabSchool");
      const tabNotif = document.getElementById("t_tabNotif");
      const paneProfile = document.getElementById("t_paneProfile");
      const paneSchool = document.getElementById("t_paneSchool");
      const paneNotif = document.getElementById("t_paneNotif");

      function setActiveTab(activeBtn, pane) {
        // remove active from all
        document.querySelectorAll(".settings-tab")
          .forEach(b => b.classList.remove("active"));

        // add active to clicked tab
        activeBtn.classList.add("active");

        // hide all panes
        paneProfile.style.display = "none";
        paneSchool.style.display = "none";
        paneNotif.style.display = "none";

        // show selected pane
        pane.style.display = "";
      }

      tabProfile.addEventListener("click", () =>
        setActiveTab(tabProfile, paneProfile)
      );

      tabSchool.addEventListener("click", () =>
        setActiveTab(tabSchool, paneSchool)
      );

      tabNotif.addEventListener("click", () =>
        setActiveTab(tabNotif, paneNotif)
      );

      async function loadProfile() {
        try {
          const res = await fetch(API_BASE + "/settings/profile", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) return;
          const p = await res.json();
          document.getElementById("t_profile_name").value = p.name || "";
          document.getElementById("t_profile_email").value = p.email || "";
          document.getElementById("t_profile_phone").value = p.phone || "";
          document.getElementById("t_profile_subject").value =
            p.subject || "";
          document.getElementById("t_profile_specialization").value =
            p.specialization || "";
        } catch (e) {
          console.error("t_loadProfile", e);
        }
      }

      document
        .getElementById("t_profileSaveBtn")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const msgEl = document.getElementById("t_profileMsg");
          msgEl.innerText = "";

          // Build payload only with non-empty values (avoid sending phone: null)
          const payload = {};
          const nameVal = document
            .getElementById("t_profile_name")
            .value.trim();
          if (nameVal !== "") payload.name = nameVal;

          const phoneVal = document
            .getElementById("t_profile_phone")
            .value.trim();
          if (phoneVal !== "") payload.phone = phoneVal; // only send when non-empty

          const subjectVal = document
            .getElementById("t_profile_subject")
            .value.trim();
          if (subjectVal !== "") payload.subject = subjectVal;

          const specVal = document
            .getElementById("t_profile_specialization")
            .value.trim();
          if (specVal !== "") payload.specialization = specVal;

          // Teachers should NOT be allowed to change password from this panel
          // (so we intentionally ignore t_profile_password here)

          if (Object.keys(payload).length === 0) {
            msgEl.innerText = "No changes to save";
            return;
          }

          try {
            const res = await fetch(API_BASE + "/settings/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify(payload),
            });
            const j = await res
              .json()
              .catch(() => ({ message: "Server error" }));
            if (!res.ok) {
              msgEl.innerText = j.message || "Save failed";
              return;
            }

            // success: refresh profile values from server and update localStorage
            await loadProfile();

            try {
              const raw =
                localStorage.getItem("user") ||
                localStorage.getItem("teacher");
              if (raw) {
                const u = JSON.parse(raw);
                if (payload.name) u.name = payload.name;
                if (payload.phone) u.phone = payload.phone;
                if (localStorage.getItem("user"))
                  localStorage.setItem("user", JSON.stringify(u));
                else if (localStorage.getItem("teacher"))
                  localStorage.setItem("teacher", JSON.stringify(u));
                const nameEl = document.getElementById("teacherName");
                if (nameEl && u.name) nameEl.innerText = u.name;
              }
            } catch (e) {
              // ignore localStorage update errors
            }

            msgEl.innerText = "";
            showToastSafe("Profile updated");
          } catch (err) {
            console.error("t_saveProfile", err);
            msgEl.innerText = "Server error";
          }
        });
      async function loadSchool() {
        try {
          const res = await fetch(API_BASE + "/settings/school", {
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) return;
          const s = await res.json();
          document.getElementById("t_school_name").innerText = s.name || "—";
          document.getElementById("t_school_address").innerText =
            s.address || "";
          document.getElementById("t_school_phone").innerText = s.phone || "";
          document.getElementById("t_school_email").innerText = s.email || "";
          document.getElementById("t_school_website").innerText =
            s.website || "";
        } catch (e) {
          console.error("t_loadSchool", e);
        }
      }

      // Robust teacher-side loadNotifications + mark-read handler
      async function loadNotifications(retryCount = 0) {
        try {
          const container = document.getElementById("t_notifList");
          if (!container) {
            // element might not be in DOM yet — retry a few times
            if (retryCount < 6) {
              await new Promise((r) => setTimeout(r, 120));
              return loadNotifications(retryCount + 1);
            } else {
              console.error(
                "t_notifList element not found. Cannot render notifications.",
              );
              return;
            }
          }

          // fetch list (server mounted as /api/settings -> endpoint: /api/settings/notifications)
          const res = await fetch(API_BASE + "/settings/notifications", {
            headers: { Authorization: "Bearer " + token },
          });

          if (!res.ok) {
            container.innerHTML =
              '<div class="small-muted">Failed to load</div>';
            // remove dot if present (we couldn't fetch)
            const settingsTab = document.querySelector(
              '.list-group-item[data-page="settings"]',
            );
            if (settingsTab) {
              const d = settingsTab.querySelector(".notif-dot");
              if (d) d.remove();
            }
            return;
          }

          // backend may return either:
          // 1) an array: [ { ... }, ... ]
          // 2) an object: { notifications: [...], unread_count: N }
          const body = await res.json();
          let list = [];
          let unreadCount = 0;

          if (Array.isArray(body)) {
            list = body;
            unreadCount = list.filter((n) => !n.is_read).length;
          } else if (body && Array.isArray(body.notifications)) {
            list = body.notifications;
            unreadCount =
              Number(body.unread_count) ||
              list.filter((n) => !n.is_read).length;
          } else {
            // Unexpected shape: try to salvage
            console.warn("notifications: unexpected response shape", body);
            list = Array.isArray(body) ? body : [];
            unreadCount = list.filter((n) => !n.is_read).length;
          }

          // update sidebar dot
          const settingsTab = document.querySelector(
            '.list-group-item[data-page="settings"]',
          );
          if (settingsTab) {
            // remove old dot
            const oldDot = settingsTab.querySelector(".notif-dot");
            if (oldDot) oldDot.remove();

            if (unreadCount > 0) {
              const dot = document.createElement("span");
              dot.className = "notif-dot";
              dot.style.cssText =
                "display:inline-block;width:10px;height:10px;background:#0d6efd;border-radius:50%;margin-left:8px;";
              settingsTab.appendChild(dot);
            }
          }

          // render list
          container.innerHTML = "";
          if (!Array.isArray(list) || !list.length) {
            container.innerHTML =
              '<div class="small-muted">No notifications</div>';
            return;
          }

          // build DOM items
          list.forEach((n) => {
            const el = document.createElement("div");
            el.className = "p-3 border rounded mb-2 position-relative";

            // unread visual marker
            if (!n.is_read) {
              el.style.borderLeft = "4px solid #0d6efd";
              el.style.background = "#fff";
            } else {
              // optional: slightly muted background for read
              el.style.background = "";
            }

            const createdAt = n.created_at
              ? new Date(n.created_at).toLocaleString()
              : "";

            el.innerHTML = `
        <div class="fw-semibold">${escapeHtml(n.title || "")}
          <small class="text-muted">(${escapeHtml(n.type || "")})</small>
        </div>
        <div class="mb-2">${escapeHtml(n.message || "")}</div>
        <div class="small-muted">${createdAt}</div>
      `;

            // Add Mark Read button only for unread notifications
            if (!n.is_read) {
              const btn = document.createElement("button");
              btn.className = "btn btn-sm btn-outline-primary mt-2";
              btn.innerText = "Mark read";

              // defensive click handler with logging and correct endpoint
              btn.addEventListener("click", async (ev) => {
                ev.preventDefault();
                try {
                  btn.disabled = true;
                  console.log("Mark-read clicked for id=", n.id);

                  // Confirm API path — server mounts settings as /api/settings
                  const url =
                    API_BASE +
                    `/settings/notifications/${encodeURIComponent(
                      n.id,
                    )}/mark-read`;
                  console.log("POST ->", url);

                  const resp = await fetch(url, {
                    method: "POST",
                    headers: {
                      Authorization: "Bearer " + token,
                      "Content-Type": "application/json",
                    },
                  });

                  console.log("mark-read response status:", resp.status);
                  // Try to get JSON body for debugging (some endpoints return empty)
                  let body = null;
                  try {
                    body = await resp.json();
                  } catch (e) {
                    body = null;
                  }

                  console.log("mark-read response body:", body);

                  if (resp.ok) {
                    // success: remove button and reload (reload ensures server persisted)
                    btn.remove();
                    // optimistic UI change
                    const dot = document.querySelector(
                      '.list-group-item[data-page="settings"] .notif-dot',
                    );
                    if (dot) dot.remove();
                    // reload notifications to reflect persisted state
                    await loadNotifications();
                  } else {
                    // show server error message if available
                    btn.disabled = false;
                    const errMsg =
                      body && body.message
                        ? body.message
                        : `Status ${resp.status}`;
                    showToastSafe(`Failed to mark read: ${errMsg}`);
                  }
                } catch (err) {
                  console.error("mark-read exception:", err);
                  btn.disabled = false;
                  showToastSafe("Network error marking notification read");
                }
              });

              el.appendChild(btn);
            }

            container.appendChild(el);
          });
        } catch (err) {
          console.error("loadNotifications error", err);
          const container = document.getElementById("t_notifList");
          if (container)
            container.innerHTML =
              '<div class="small-muted">Failed to load</div>';
        }
      }

      async function markNotificationRead(nid) {
        if (!nid) return;
        // disable further clicks while in progress handled by caller
        try {
          const url = `${API}/notifications/${encodeURIComponent(
            nid,
          )}/mark-read`;
          const res = await fetch(url, {
            method: "POST",
            headers: { Authorization: "Bearer " + token },
          });
          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            console.warn("markNotificationRead failed", res.status, txt);
            throw new Error("Failed to mark read");
          }
          return true;
        } catch (err) {
          console.error("markNotificationRead error", err);
          return false;
        }
      }

      // observe when teacher opens settings via sidebar
      document.addEventListener("DOMContentLoaded", () => {
        const pageSettings = document.getElementById("page-settings");
        const observer = new MutationObserver((mut) => {
          if (pageSettings && !pageSettings.classList.contains("d-none")) {
            loadProfile().catch(() => { });
            loadSchool().catch(() => { });
            loadNotifications().catch(() => { });
            setActiveTab(tabProfile, paneProfile);
            observer.disconnect();
          }
        });
        if (pageSettings)
          observer.observe(pageSettings, {
            attributes: true,
            attributeFilter: ["class"],
          });
      });
    })();

    // outside wrapper → globally accessible
    window.markNotificationRead = async function (nid) {
      console.log("markNotificationRead global: nid =", nid);
      const token = localStorage.getItem("token");

      const url = `${API}/teachers/notifications/${nid}/mark-read`;
      console.log("POST", url);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
        body: "{}",
      });

      console.log("Status:", res.status);
      return res.ok;
    };
  </script>

  <!-- ======= ADDED: Chart.js CDN + dashboard widgets initializer ======= -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // local YYYY-MM-DD (uses local timezone, not UTC)
    function localDateISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // Replaces previous initDashboardWidgets - uses single /teachers/:id/dashboard endpoint
    async function initDashboardWidgets() {
      try {
        if (
          typeof API === "undefined" ||
          typeof token === "undefined" ||
          typeof user === "undefined"
        ) {
          console.warn(
            "initDashboardWidgets: missing API/token/user — skipping",
          );
          return;
        }

        const canvas = document.getElementById("attendanceChartMini");
        const pctEl = document.getElementById("attendancePctMini");
        const noticesEl = document.getElementById(
          "notificationsContainerMini",
        );
        const openSettingsBtn = document.getElementById(
          "openNotificationsSettingsMini",
        );

        // show small loading states
        if (pctEl) pctEl.innerText = "—";
        if (noticesEl)
          noticesEl.innerHTML =
            '<div class="small-muted p-2">Loading notifications…</div>';

        const url = `${API}/teachers/${encodeURIComponent(
          user.id,
        )}/dashboard`;
        const res = await fetch(url, {
          headers: { Authorization: "Bearer " + token },
        });
        if (!res.ok) {
          console.warn("dashboard fetch failed", res.status);
          if (noticesEl)
            noticesEl.innerHTML =
              '<div class="small-muted p-2">Failed to load</div>';
          return;
        }
        const body = await res.json();

        if (typeof renderTeacherXP == "function") {
          try {
            renderTeacherXP(body);
          } catch (e) {
            console.error("renderTeacherXP failed", e);
          }
        }

        // --- KPI: Total Students ---
        if (typeof body.studentsCount !== "undefined") {
          const cs = document.getElementById("countStudents");
          if (cs) cs.innerText = body.studentsCount;
        }

        // --- KPI: Today's Attendance (ALWAYS "P out of N") ---
        {
          const attEl = document.getElementById("countAttendance");
          if (attEl) {
            const present = body.todayAttendanceCount || 0;
            const total = body.todayTotal || body.studentsCount || 0;
            attEl.innerText = `${present} out of ${total}`;
          }
        }

        // --- KPI: Course/Subject ---
        {
          const subjEl = document.getElementById("teacherSubject");
          if (subjEl) {
            const subject =
              user && (user.subject || user.specialization)
                ? (user.subject || "") +
                (user.specialization ? " / " + user.specialization : "")
                : "—";

            let batchText = "—";
            if (
              Array.isArray(body.assignedBatches) &&
              body.assignedBatches.length
            ) {
              batchText = body.assignedBatches
                .map(
                  (b) =>
                    `${b.course || ""} ${b.batch || ""}${b.year ? " (" + b.year + ")" : ""
                    }`,
                )
                .join(" • ");
            }

            subjEl.innerHTML = `<div>${escapeHtml(
              subject,
            )}</div><div class="small-muted">${escapeHtml(batchText)}</div>`;
          }
        }

        // --- Attendance Chart (7 days) ---
        // ---------- attendance mini widget: normalize & draw ----------
        (function () {
          try {
            // compute last7 local dates (server/local sync)
            const last7 = [];
            for (let i = 6; i >= 0; i--) {
              const d = new Date();
              d.setDate(d.getDate() - i);
              last7.push(
                `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
                  2,
                  "0",
                )}-${String(d.getDate()).padStart(2, "0")}`,
              );
            }

            // helper: normalize incoming date-like values to local YYYY-MM-DD
            function normalizeToLocalDateStr(raw) {
              if (!raw) return null;
              // if it's already YYYY-MM-DD
              if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
              // try Date object / ISO string
              const dt = new Date(raw);
              if (isNaN(dt.getTime())) return null;
              return `${dt.getFullYear()}-${String(
                dt.getMonth() + 1,
              ).padStart(2, "0")}-${String(dt.getDate()).padStart(2, "0")}`;
            }

            // raw array from server
            const raw = Array.isArray(body && body.attendance7)
              ? body.attendance7
              : [];

            // normalize and produce lookup by date
            const byDate = {};
            raw.forEach((r) => {
              // server may return {date} or {dt} or {attendance_date}
              const rawDate =
                r && (r.date || r.dt || r.attendance_date)
                  ? r.date || r.dt || r.attendance_date
                  : null;
              const dstr = normalizeToLocalDateStr(rawDate);
              const presents = Number(
                (r && (r.presents ?? r.present ?? r.present_count)) || 0,
              );
              const total = Number(
                (r && (r.total ?? r.count ?? r.student_total)) || 0,
              );
              const p = Number.isFinite(presents) ? presents : 0;
              const t = Number.isFinite(total) ? total : 0;
              const pct = t > 0 ? Math.round((p / t) * 100) : 0;
              if (dstr)
                byDate[dstr] = { date: dstr, presents: p, total: t, pct };
            });

            // build ordered attendance7 aligned to last7 (ensures holes show zeros)
            const attendance7 = last7.map(
              (d) => byDate[d] || { date: d, presents: 0, total: 0, pct: 0 },
            );

            // weighted average across days: sum(presents)/sum(total)
            let sumP = 0,
              sumT = 0;
            attendance7.forEach((a) => {
              sumP += Number(a.presents || 0);
              sumT += Number(a.total || 0);
            });
            const avgPct = sumT > 0 ? Math.round((sumP / sumT) * 100) : null;

            // update big KPI element (keep the id the same as your HTML)
            const avgEl =
              document.getElementById("attendancePctMini") ||
              document.getElementById("attendanceAvgMini");
            if (avgEl) avgEl.innerText = avgPct === null ? "—" : avgPct + "%";

            // remove or update the small pct element (older templates used a small element under the big KPI)
            // If you want to keep small last-day pct, ensure the element id exists in markup; otherwise skip.
            const smallEl = document.getElementById("attendancePctMiniSmall");
            const lastDay = attendance7.length
              ? attendance7[attendance7.length - 1]
              : null;
            if (smallEl)
              smallEl.innerText =
                lastDay && typeof lastDay.pct === "number"
                  ? lastDay.pct + "%"
                  : "—";

            // prepare chart data
            const labels = attendance7.map((a) =>
              a.date ? a.date.slice(5) : "",
            );
            const dataPts = attendance7.map((a) =>
              typeof a.pct === "number" ? a.pct : 0,
            );

            // draw chart using Chart.js (ensure Chart is loaded)
            const canvas = document.getElementById("attendanceChartMini");
            if (canvas && window.Chart) {
              try {
                if (window._attendanceMiniChart) {
                  try {
                    window._attendanceMiniChart.destroy();
                  } catch (e) { }
                  window._attendanceMiniChart = null;
                }
                const ctx = canvas.getContext("2d");
                window._attendanceMiniChart = new Chart(ctx, {
                  type: "line",
                  data: {
                    labels,
                    datasets: [
                      {
                        label: "Present %",
                        data: dataPts,
                        tension: 0.35,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: 3,
                        borderColor: "#0d6efd",
                        backgroundColor: "rgba(13,110,253,0.08)",
                        pointBackgroundColor: "#0d6efd",
                        pointBorderColor: "#ffffff",
                        pointStyle: "circle",
                        fill: false,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    spanGaps: true,
                    plugins: {
                      legend: { display: false },
                      tooltip: {
                        callbacks: {
                          label: function (context) {
                            const idx = context.dataIndex;
                            const a = attendance7[idx] || {};
                            const presents = Number(a.presents || 0);
                            const total = Number(a.total || 0);
                            const pct = typeof a.pct === "number" ? a.pct : 0;
                            if (!total) return "No data";
                            return `${presents}/${total} present (${pct}%)`;
                          },
                        },
                      },
                    },
                    scales: {
                      y: { display: false, min: 0, max: 100 },
                      x: { grid: { display: false } },
                    },
                    elements: { point: { hitRadius: 6 } },
                    onClick: function (evt, activeEls) {
                      if (!activeEls || !activeEls.length) return;
                      const idx = activeEls[0].index;
                      const item = attendance7[idx];
                      if (!item || !item.date) {
                        alert("No attendance data for this day");
                        return;
                      }
                      const attNav = document.querySelector(
                        '.list-group-item[data-page="attendance"]',
                      );
                      if (attNav) attNav.click();
                      setTimeout(function () {
                        const sel = document.getElementById(
                          "attendanceBatchSelect",
                        );
                        const din = document.getElementById("attendanceDate");
                        if (
                          Array.isArray(body.assignedBatches) &&
                          body.assignedBatches.length
                        ) {
                          if (sel)
                            sel.value = String(body.assignedBatches[0].id);
                        }
                        if (din) din.value = item.date;
                        const loadBtn =
                          document.getElementById("loadAttendanceBtn");
                        if (loadBtn) loadBtn.click();
                      }, 220);
                    },
                  },
                });
              } catch (chartErr) {
                console.error("attendance chart draw failed", chartErr);
              }
            }
          } catch (err) {
            console.error("attendance7 processing error", err);
          }
        })();

        // --- Notifications ---
        const nots = Array.isArray(body.notifications)
          ? body.notifications
          : [];
        if (noticesEl) {
          noticesEl.innerHTML = "";
          if (!nots.length) {
            noticesEl.innerHTML =
              '<div class="small-muted p-2">No notifications or notices.</div>';
          } else {
            nots.slice(0, 10).forEach((n) => {
              const div = document.createElement("div");
              div.className = "p-2 border rounded mb-2 position-relative";
              if (!n.is_read) {
                div.style.borderLeft = "4px solid #0d6efd";
                div.style.background = "#fff";
              }
              const createdAt = n.created_at
                ? new Date(n.created_at).toLocaleString()
                : "";
              const title =
                n.title ||
                n.subject ||
                (n.message ? n.message.slice(0, 40) : "Notice");
              const msg = n.message || n.body || "";
              div.innerHTML = `<div style="font-weight:600">${escapeHtml(
                title,
              )}</div>
                         <div class="small-muted">${escapeHtml(
                msg.slice(0, 120),
              )}${createdAt ? " • " + escapeHtml(createdAt) : ""
                }</div>`;

              // click on card: open link or go to settings->notifications
              div.addEventListener("click", (ev) => {
                // if click is on the mark-read button, ignore (button has its own handler)
                if (
                  ev.target &&
                  ev.target.closest &&
                  ev.target.closest(".mark-read-btn")
                )
                  return;
                if (n.link) window.open(n.link, "_blank");
                else {
                  const sNav = document.querySelector(
                    '.list-group-item[data-page="settings"]',
                  );
                  if (sNav) sNav.click();
                  setTimeout(() => {
                    const tBtn = document.getElementById("t_tabNotif");
                    if (tBtn) tBtn.click();
                  }, 220);
                }
              });

              // show Mark read button for unread notifications
              if (!n.is_read) {
                const btn = document.createElement("button");
                btn.className =
                  "btn btn-sm btn-outline-primary mt-2 mark-read-btn";
                btn.innerText = "Mark read";
                // clicking only marks read (prevent card click)
                btn.addEventListener("click", async (ev) => {
                  ev.stopPropagation();
                  // disable button & show spinner
                  btn.disabled = true;
                  const sp = document.createElement("span");
                  sp.className = "spinner-border spinner-border-sm ms-2";
                  sp.setAttribute("role", "status");
                  sp.ariaHidden = "true";
                  btn.appendChild(sp);

                  const ok = await markNotificationRead(n.id);
                  if (ok) {
                    // optimistic UI: remove button, mark item as read visually
                    btn.remove();
                    div.style.borderLeft = "";
                    div.style.background = "";
                    // update sidebar dot (decrement or remove)
                    try {
                      const settingsTab = document.querySelector(
                        '.list-group-item[data-page="settings"]',
                      );
                      if (settingsTab) {
                        const dot = settingsTab.querySelector(".notif-dot");
                        if (dot) {
                          // re-fetch dashboard or simply remove dot when no unread left.
                          // we'll do a lightweight approach: try to decrement number shown (if you store it), else re-init widgets
                          // safest approach: re-fetch dashboard to update unread_count and other tiles
                          setTimeout(
                            () => initDashboardWidgets().catch(() => { }),
                            120,
                          );
                        }
                      }
                    } catch (e) {
                      /* ignore */
                    }
                  } else {
                    // restore button and show small error
                    btn.disabled = false;
                    const errMsg = document.createElement("div");
                    errMsg.className = "text-danger small mt-1";
                    errMsg.innerText = "Failed to mark read. Try again";
                    btn.insertAdjacentElement("afterend", errMsg);
                  }
                });
                div.appendChild(btn);
              }

              noticesEl.appendChild(div);
            });

            const foot = document.createElement("div");
            foot.className = "d-flex justify-content-end mt-2";
            foot.innerHTML =
              '<button id="viewAllNoticesMini" class="btn btn-sm btn-outline-secondary">View all</button>';
            noticesEl.appendChild(foot);
            foot
              .querySelector("#viewAllNoticesMini")
              .addEventListener("click", () => {
                const sNav = document.querySelector(
                  '.list-group-item[data-page="settings"]',
                );
                if (sNav) sNav.click();
                setTimeout(() => {
                  const tBtn = document.getElementById("t_tabNotif");
                  if (tBtn) tBtn.click();
                }, 220);
              });
          }
        }

        // update sidebar notifications dot (unread_count from payload)
        try {
          const settingsTab = document.querySelector(
            '.list-group-item[data-page="settings"]',
          );
          if (settingsTab) {
            const oldDot = settingsTab.querySelector(".notif-dot");
            if (oldDot) oldDot.remove();
            const unread = Number(
              body.unread_count ||
              (Array.isArray(nots)
                ? nots.filter((n) => !n.is_read).length
                : 0),
            );
            if (unread > 0) {
              const dot = document.createElement("span");
              dot.className = "notif-dot";
              dot.style.cssText =
                "display:inline-block;width:10px;height:10px;background:#0d6efd;border-radius:50%;margin-left:8px;";
              settingsTab.appendChild(dot);
            }
          }
        } catch (err) {
          /* ignore */
        }

        // wire open settings button to open settings->notifications
        if (openSettingsBtn) {
          openSettingsBtn.onclick = () => {
            const sNav = document.querySelector(
              '.list-group-item[data-page="settings"]',
            );
            if (sNav) sNav.click();
            setTimeout(() => {
              const tBtn = document.getElementById("t_tabNotif");
              if (tBtn) tBtn.click();
            }, 220);
          };
        }
      } catch (err) {
        console.error("initDashboardWidgets error", err);
        const noticesEl = document.getElementById(
          "notificationsContainerMini",
        );
        if (noticesEl)
          noticesEl.innerHTML =
            '<div class="small-muted p-2">Failed to load</div>';
      }
    }

    function renderTeacherXP(body) {
      try {
        console.debug("[XP] renderTeacherXP called with body:", body);

        // Support multiple field names in case server differs
        const xpRaw =
          body?.xp ?? body?.xp_points ?? body?.points ?? body?.xp_value ?? 0;
        const lvlRaw = body?.level ?? body?.lvl ?? 1;
        const targetRaw =
          body?.next_xp_target ?? body?.xp_needed ?? body?.target ?? 250;

        const xp = Number(xpRaw) || 0;
        const level = Number(lvlRaw) || 1;
        const target = Number(targetRaw) || 250;

        const pct = target > 0 ? Math.round((xp / target) * 100) : 0;

        // Update UI (defensive: check elements)
        const pointsEl = document.getElementById("teacherXpPoints");
        const metaEl = document.getElementById("teacherXpMeta");
        const barEl = document.getElementById("teacherXpBar");
        const barTxt = document.getElementById("teacherXpBarText");

        console.debug(
          `[XP] writing UI -> xp:${xp} level:${level} target:${target} pct:${pct}`,
        );

        if (pointsEl) pointsEl.innerText = xp;
        if (metaEl) metaEl.innerText = `Level ${level} • ${pct}%`;
        if (barEl) barEl.style.width = Math.min(100, pct) + "%";
        if (barTxt) barTxt.innerText = `${xp} / ${target} XP • ${pct}%`;

        if (level >= 10) {
          if (barTxt) barTxt.innerText = `Level 10 — Congratulations!`;
        }

        // return values for tests (handy if you call it from console)
        return { xp, level, target, pct };
      } catch (err) {
        console.error("renderTeacherXP error:", err);
      }
    }

    // run after DOM ready (keep small delay to allow other code to set API/user)
    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(() => {
        initDashboardWidgets().catch(console.error);
      }, 120);
    });

    // helper escape
    function escapeHtml(s = "") {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    setTimeout(() => {
      pollSystemStatus(); // run once
      setInterval(pollSystemStatus, 30000); // run every 30s
    }, 500);
  </script>

  <!-- ======= end added chart + widgets ======= -->

  <script>
    function updateSystemStatus({
      server = "Checking…",
      serverState = "checking",
      sync = "—",
      response = "—",
    } = {}) {
      const serverEl = document.getElementById("status-server-value");
      const syncEl = document.getElementById("status-sync-value");
      const respEl = document.getElementById("status-response-value");

      if (serverEl) {
        serverEl.innerText = server;
        serverEl.className = "status-dot " + serverState;
      }
      if (syncEl) syncEl.innerText = sync;
      if (respEl) respEl.innerText = response;
    }

    async function pollSystemStatus() {
      const start = performance.now();

      try {
        const res = await fetch(`${API}/health`, {
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
        });

        const ms = Math.round(performance.now() - start);

        if (!res.ok) {
          updateSystemStatus({
            server: "Down",
            serverState: "err",
            sync: "—",
            response: ms + "ms",
          });
          return;
        }

        const data = await res.json();

        updateSystemStatus({
          server: data.status || "OK",
          serverState: data.status === "OK" ? "ok" : "err",
          sync: data.sync || "Online",
          response: ms + "ms",
        });
      } catch (e) {
        updateSystemStatus({
          server: "Error",
          serverState: "err",
          sync: "—",
          response: "N/A",
        });
      }
    }

    // initial + interval
    setTimeout(() => {
      pollSystemStatus();
      setInterval(pollSystemStatus, 30000);
    }, 500);
  </script>

  <!-- Toast container (place near end of body) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div id="appToastBody" class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- ================= Add Assignment Modal ================= -->
  <div class="modal fade" id="addAssignmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">New Assignment</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="addAssignmentForm">
            <div class="mb-2">
              <label class="small-muted">Batch</label>
              <select id="assignmentBatch" class="form-select">
                <option value="">Select batch</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="small-muted">Subject</label>
              <input id="assignmentSubject" class="form-control" placeholder="e.g. Java Programming" />
            </div>

            <div class="mb-2">
              <label class="small-muted">Title</label>
              <input id="assignmentTitle" class="form-control" placeholder="Assignment title" />
            </div>

            <div class="mb-2">
              <label class="small-muted">Description</label>
              <textarea id="assignmentDescription" class="form-control" rows="3"></textarea>
            </div>

            <div class="mb-2">
              <label class="small-muted">Due Date</label>
              <input id="assignmentDueDate" type="date" class="form-control" />
            </div>

            <div id="assignmentMsg" class="text-danger small mt-2"></div>
          </form>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button id="saveAssignmentBtn" class="btn btn-primary">
            Save Assignment
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Assignment Confirmation Modal -->
  <div class="modal fade" id="deleteAssignmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title text-danger">Delete Assignment</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <p class="mb-0">Are you sure you want to delete this assignment?</p>
          <small class="text-muted">This action cannot be undone.</small>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
            Cancel
          </button>
          <button id="confirmDeleteAssignmentBtn" class="btn btn-danger btn-sm">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Note Modal -->
  <div class="modal fade" id="submissionNoteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">Student Note</h6>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="small-muted mb-1">Student</div>
          <div id="noteStudentName" class="fw-semibold mb-3"></div>

          <div class="small-muted mb-1">Message</div>
          <div id="noteContent" class="p-3 rounded" style="background:#f8fafc; white-space:pre-wrap;">
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Submission Save Toast (place near end of body) -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="teacherToast" class="toast text-bg-dark" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="teacherToastMsg"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast">
        </button>
      </div>
    </div>
  </div>

  <script>
    function showTeacherToast(message, type = "dark") {
      const toastEl = document.getElementById("teacherToast");
      const msgEl = document.getElementById("teacherToastMsg");

      toastEl.className = `toast text-bg-${type}`;
      msgEl.innerText = message;

      new bootstrap.Toast(toastEl).show();
    }
  </script>


  <!-- Logout Confirmation Modal (paste once near end of <body>) -->
  <style>
    /* small local styles for the modal icon & layout */
    .logout-modal .icon-wrap {
      width: 72px;
      height: 72px;
      border-radius: 999px;
      background: rgba(220, 53, 69, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px auto;
    }

    .logout-modal .icon-wrap svg {
      width: 36px;
      height: 36px;
      color: #dc3545;
    }

    .logout-modal .modal-title {
      text-align: center;
      font-weight: 600;
    }

    .logout-modal .modal-body {
      text-align: center;
      color: #6b7280;
    }

    .logout-modal .modal-footer {
      justify-content: center;
      gap: 12px;
      padding-bottom: 18px;
    }
  </style>

  <div class="modal fade logout-modal" id="logoutConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-body pt-4 pb-0 px-4">
          <div class="icon-wrap mb-2" aria-hidden="true">
            <!-- error / warning SVG -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M11.001 7h2v6h-2V7zM11 15h2v2h-2v-2z" fill="currentColor" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M1.257 20.71A1 1 0 0 0 2.18 22h19.64a1 1 0 0 0 .923-1.29L13.923 3.29a1 1 0 0 0-1.846 0L1.257 20.71zM4.06 20L12 5.157 19.94 20H4.06z"
                fill="currentColor" />
            </svg>
          </div>

          <h5 class="modal-title">Are you sure?</h5>
          <p class="modal-body small">
            You will be logged out and your session will end on this device.
          </p>
        </div>

        <div class="modal-footer pb-3">
          <button id="confirmLogoutBtn" type="button" class="btn btn-danger">
            Logout
          </button>
          <button id="cancelLogoutBtn" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const logoutBtn = document.getElementById("logout"); // top-right logout button
      const confirmBtn = document.getElementById("confirmLogoutBtn"); // modal confirm
      const logoutModalEl = document.getElementById("logoutConfirmModal");

      if (!logoutBtn) {
        console.warn("Logout button not found (#logout)");
      } else {
        logoutBtn.addEventListener("click", (e) => {
          e.preventDefault();
          if (!logoutModalEl) {
            console.warn("Logout modal not found (#logoutConfirmModal)");
            return;
          }
          try {
            const modal = new bootstrap.Modal(logoutModalEl);
            modal.show();
          } catch (err) {
            console.error("Failed to show logout modal", err);
          }
        });
      }

      if (!confirmBtn) {
        console.warn("Confirm logout button not found (#confirmLogoutBtn)");
        return;
      }

      confirmBtn.addEventListener("click", async () => {
        try {
          // disable confirm button & add spinner
          confirmBtn.setAttribute("disabled", "disabled");
          const spinner = document.createElement("span");
          spinner.className = "spinner-border spinner-border-sm ms-2";
          spinner.setAttribute("role", "status");
          spinner.ariaHidden = "true";
          spinner.dataset.temp = "spinner";
          confirmBtn.appendChild(spinner);

          // clear session
          try {
            localStorage.clear();
            sessionStorage.clear();
          } catch (e) {
            console.warn("Failed clearing localStorage", e);
          }

          // hide modal
          const modalInstance = bootstrap.Modal.getInstance(logoutModalEl);
          if (modalInstance) modalInstance.hide();

          setTimeout(() => {
            window.location.replace("index.html");
          }, 180);
        } catch (err) {
          console.error("Error during logout", err);
          confirmBtn.removeAttribute("disabled");
          const s = confirmBtn.querySelector('[data-temp="spinner"]');
          if (s) s.remove();
        }
      });
    });
  </script>
</body>

</html>